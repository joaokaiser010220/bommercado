<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pequenos Sapich√µes - Plataforma de Estudos</title>
  
  <style>
    /* RESET B√ÅSICO */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body, html {
      height: 100%;
      background: #f5f5f5;
      color: #2e2e2e;
      overflow-x: hidden;
    }
    /* TELA DE CARREGAMENTO */
    #loadingScreen {
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: #4caf50;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      font-weight: 700;
      z-index: 99999;
    }
    #loadingSpinner {
      margin-top: 15px;
      width: 50px;
      height: 50px;
      border: 6px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to {transform: rotate(360deg);}
    }

    /* CONTAINER PRINCIPAL */
    #appContainer {
      display: flex;
      height: 100vh;
      padding: 20px;
      gap: 25px;
      transition: padding 0.3s;
    }

    /* HEADER */
    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 60px;
      background: #388e3c;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 30px;
      font-size: 1.25rem;
      font-weight: 600;
      z-index: 1000;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    #logoutBtn {
      background: #2e7d32;
      border: none;
      color: white;
      padding: 7px 14px;
      border-radius: 22px;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #logoutBtn:hover, #logoutBtn:focus {
      background: #1b5e20;
      outline: none;
    }

    /* √ÅREA DE MAT√âRIAS */
    main {
      flex: 1;
      overflow-y: auto;
      padding-top: 80px;
      display: flex;
      flex-direction: column;
      gap: 35px;
    }

    h2 {
      font-family: 'Fredoka One', cursive;
      color: #2e7d32;
      margin-bottom: 14px;
      user-select: none;
    }

    /* CONTAINER DAS MAT√âRIAS */
    .materias-container {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(130px, 1fr));
      gap: 20px;
      padding-bottom: 10px;
    }

    /* CARD DE MAT√âRIA */
    .materia-card {
      background: white;
      border-radius: 20px;
      padding: 22px 16px;
      box-shadow: 0 4px 15px rgba(46, 125, 50, 0.25);
      cursor: pointer;
      user-select: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: transform 0.3s, box-shadow 0.3s;
      outline-offset: 3px;
    }
    .materia-card:hover, .materia-card:focus {
      transform: translateY(-6px);
      box-shadow: 0 7px 20px rgba(46, 125, 50, 0.45);
      outline: 3px solid #2e7d32;
    }
    .materia-icone {
      font-size: 3.8rem;
      margin-bottom: 14px;
      pointer-events: none;
    }
    .materia-nome {
      font-size: 1.3rem;
      font-weight: 700;
      color: #2e7d32;
      text-align: center;
      pointer-events: none;
    }

    /* MODAL DE N√çVEIS */
    #modalNiveis {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 1500;
    }
    #modalNiveis.active {
      opacity: 1;
      pointer-events: auto;
    }
    #modalConteudo {
      background: white;
      padding: 25px 30px 30px;
      border-radius: 24px;
      max-width: 420px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      user-select: none;
    }
    #btnFecharModal {
      position: absolute;
      top: 14px;
      right: 20px;
      font-size: 28px;
      background: none;
      border: none;
      cursor: pointer;
      color: #2e7d32;
      transition: color 0.25s;
    }
    #btnFecharModal:hover, #btnFecharModal:focus {
      color: #145214;
      outline: none;
    }
    #tituloModal {
      font-family: 'Fredoka One', cursive;
      font-size: 1.9rem;
      color: #2e7d32;
      margin-bottom: 24px;
      text-align: center;
    }
    #listaNiveis {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }
    #listaNiveis button {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: 2.8px solid #4caf50;
      background: white;
      font-weight: 700;
      font-size: 1.3rem;
      color: #2e7d32;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
    }
    #listaNiveis button:hover, #listaNiveis button:focus {
      background: #4caf50;
      color: white;
      outline: none;
    }

    /* CHAT TOGGLE */
    #chatToggleBtn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #4caf50;
      color: white;
      font-size: 2.4rem;
      padding: 16px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(46, 125, 50, 0.85);
      transition: background-color 0.3s;
      z-index: 1501;
      user-select: none;
    }
    #chatToggleBtn:hover, #chatToggleBtn:focus {
      background: #2e7d32;
      outline: none;
    }

    /* CHAT CONTAINER */
    #chatContainer {
      position: fixed;
      bottom: 80px;
      right: 24px;
      width: 360px;
      max-height: 540px;
      background: white;
      border-radius: 18px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.18);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transform: translateX(400px);
      opacity: 0;
      pointer-events: none;
      transition: transform 0.35s ease, opacity 0.35s ease;
      z-index: 1500;
    }
    #chatContainer.open {
      transform: translateX(0);
      opacity: 1;
      pointer-events: auto;
    }
    #chatHeader {
      background: #388e3c;
      color: white;
      font-weight: 700;
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }
    #chatCloseBtn {
      background: transparent;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: white;
      transition: color 0.25s;
    }
    #chatCloseBtn:hover, #chatCloseBtn:focus {
      color: #a5d6a7;
      outline: none;
    }
    #chatMessages {
      flex: 1;
      overflow-y: auto;
      padding: 15px 20px;
      font-size: 1rem;
      background: #e8f5e9;
      display: flex;
      flex-direction: column;
      gap: 10px;
      outline: none;
    }
    /* Scrollbar chat */
    #chatMessages::-webkit-scrollbar {
      width: 7px;
    }
    #chatMessages::-webkit-scrollbar-thumb {
      background: #4caf50;
      border-radius: 10px;
    }
    #chatMessages::-webkit-scrollbar-track {
      background: #c8e6c9;
      border-radius: 10px;
    }
    /* Mensagens */
    .message {
      max-width: 80%;
      padding: 9px 15px;
      border-radius: 18px;
      line-height: 1.3;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .botMessage {
      background: #4caf50;
      color: white;
      align-self: flex-start;
      font-weight: 600;
    }
    .userMessage {
      background: #a5d6a7;
      color: #1b5e20;
      align-self: flex-end;
      font-weight: 700;
    }

    /* Input do chat */
    #chatInputContainer {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #dcedc8;
      align-items: center;
    }
    #chatInput {
      flex: 1;
      padding: 10px 14px;
      border-radius: 24px;
      border: none;
      font-size: 1rem;
      outline: none;
      font-weight: 600;
    }
    #chatInput::placeholder {
      font-style: italic;
      color: #5d8a3a;
    }
    #chatSendBtn, #chatMicBtn {
      background: #4caf50;
      border: none;
      color: white;
      font-weight: 900;
      padding: 10px 18px;
      font-size: 1.2rem;
      border-radius: 25px;
      cursor: pointer;
      box-shadow: 0 4px 14px rgba(27, 96, 27, 0.65);
      transition: background-color 0.3s;
      user-select: none;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #chatSendBtn:hover, #chatMicBtn:hover {
      background: #388e3c;
    }
    #chatMicBtn {
      width: 46px;
      height: 46px;
    }

    /* NOTIFICA√á√ÉO */
    .notificacao {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background-color: #4caf50;
      color: white;
      padding: 15px 22px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      font-weight: 700;
      font-family: 'Fredoka One', cursive;
      z-index: 99999;
      user-select: none;
      opacity: 0;
      transition: opacity 0.5s;
    }

    /* RESPONSIVIDADE */
    @media (max-width: 920px) {
      #appContainer {
        flex-direction: column;
        padding: 15px 12px;
      }
      main {
        padding-top: 100px;
      }
      #chatContainer {
        bottom: 0;
        right: 0;
        width: 100%;
        max-height: 350px;
        border-radius: 0;
        transform: translateY(100%);
      }
      #chatContainer.open {
        transform: translateY(0);
      }
      #chatToggleBtn {
        bottom: 14px;
        right: 14px;
        font-size: 2.8rem;
      }
    }
  </style>
  
</head>
<body>
  <div id="loadingScreen" role="alert" aria-live="assertive">
    Carregando Pequenos Sapich√µes...
    <div id="loadingSpinner" aria-hidden="true"></div>
  </div>

  <header>
    <div id="nomeUsuario" aria-live="polite" aria-atomic="true">Ol√°!</div>
    <button id="logoutBtn" aria-label="Sair do sistema" title="Sair">Sair</button>
  </header>

  <div id="appContainer">
    <main aria-label="Lista de mat√©rias e conte√∫dos">
      <section aria-label="Mat√©rias Favoritas">
        <h2>Mat√©rias Favoritas</h2>
        <div id="materiasFavoritas" class="materias-container" aria-live="polite" aria-atomic="true" aria-relevant="additions"></div>
      </section>
      <section aria-label="Outras mat√©rias dispon√≠veis">
        <h2>Outras Mat√©rias</h2>
        <div id="materiasOutras" class="materias-container" aria-live="polite" aria-atomic="true" aria-relevant="additions"></div>
      </section>
    </main>
  </div>

  <!-- Modal N√≠veis -->
  <div id="modalNiveis" role="dialog" aria-modal="true" aria-labelledby="tituloModal" tabindex="-1">
    <div id="modalConteudo">
      <button id="btnFecharModal" aria-label="Fechar modal">&times;</button>
      <h3 id="tituloModal"></h3>
      <div id="listaNiveis" role="list"></div>
    </div>
  </div>

  <!-- Bot√£o Chat -->
  <button id="chatToggleBtn" aria-label="Abrir chat de ajuda" aria-pressed="false" title="Abrir chat">üí¨</button>

  <!-- Chat Container -->
  <aside id="chatContainer" role="region" aria-label="Chat de ajuda interativo" aria-hidden="true" tabindex="-1">
    <header id="chatHeader">
      Pequenos Sapich√µes Chat
      <button id="chatCloseBtn" aria-label="Fechar chat">&times;</button>
    </header>
    <div id="chatMessages" tabindex="0" aria-live="polite" aria-relevant="additions"></div>
    <div id="chatInputContainer">
      <button id="chatMicBtn" aria-label="Ativar microfone para ditado">üéôÔ∏è</button>
      <input type="text" id="chatInput" aria-label="Digite sua mensagem" placeholder="Digite sua mensagem aqui..." autocomplete="off" />
      <button id="chatSendBtn" aria-label="Enviar mensagem">Enviar</button>
    </div>
  </aside>

  <script>
    const todasMaterias = [
      { nome: 'Matem√°tica', icone: '‚ûó', slug: 'MAT' },
      { nome: 'Portugu√™s', icone: 'üìö', slug: 'POR' },
      { nome: 'Hist√≥ria', icone: 'üè∞', slug: 'HIS' },
      { nome: 'Geografia', icone: 'üåç', slug: 'GEO' },
      { nome: 'Artes', icone: 'üé®', slug: 'ART' },
    ];

    // DOM elements
    const nomeUsuarioEl = document.getElementById('nomeUsuario');
    const logoutBtn = document.getElementById('logoutBtn');
    const materiasFavoritasEl = document.getElementById('materiasFavoritas');
    const materiasOutrasEl = document.getElementById('materiasOutras');
    const modalNiveis = document.getElementById('modalNiveis');
    const tituloModal = document.getElementById('tituloModal');
    const listaNiveis = document.getElementById('listaNiveis');
    const btnFecharModal = document.getElementById('btnFecharModal');
    const chatToggleBtn = document.getElementById('chatToggleBtn');
    const chatContainer = document.getElementById('chatContainer');
    const chatCloseBtn = document.getElementById('chatCloseBtn');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const chatSendBtn = document.getElementById('chatSendBtn');
    const chatMicBtn = document.getElementById('chatMicBtn');
    const loadingScreen = document.getElementById('loadingScreen');

    let materiaSelecionada = null;
    let chatAberto = false;
    let reconhecimentoAtivo = false;
    let recognition;

    // Fun√ß√£o para obter usu√°rio logado do localStorage
    function getUsuarioLogado() {
      const str = localStorage.getItem('usuarioLogado');
      if (!str) return null;
      try {
        return JSON.parse(str);
      } catch {
        return null;
      }
    }

    // Criar notifica√ß√£o tempor√°ria
    function mostrarNotificacao(msg, tempo=3500) {
      const notif = document.createElement('div');
      notif.className = 'notificacao';
      notif.textContent = msg;
      document.body.appendChild(notif);
      // Aparecer com fade
      setTimeout(() => notif.style.opacity = '1', 50);
      // Sumir depois do tempo
      setTimeout(() => {
        notif.style.opacity = '0';
        setTimeout(() => notif.remove(), 500);
      }, tempo);
    }

    // Criar card da mat√©ria
    function criarCardMateria(materia) {
      const div = document.createElement('div');
      div.className = 'materia-card';
      div.tabIndex = 0;
      div.setAttribute('role', 'button');
      div.setAttribute('aria-pressed', 'false');
      div.title = `Abrir n√≠veis de ${materia.nome}`;
      div.innerHTML = `
        <div class="materia-icone" aria-hidden="true">${materia.icone}</div>
        <div class="materia-nome">${materia.nome}</div>
      `;
      div.onclick = () => abrirModalNiveis(materia);
      div.onkeydown = e => {
        if(e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          abrirModalNiveis(materia);
        }
      };
      return div;
    }

    // Mostrar mat√©rias na tela
    function mostrarMaterias(usuario) {
      materiasFavoritasEl.innerHTML = '';
      materiasOutrasEl.innerHTML = '';

      let favoritas = [];
      if (Array.isArray(usuario.materias)) favoritas = usuario.materias;
      else if (typeof usuario.materia === 'string') favoritas = [usuario.materia];

      favoritas.forEach(nomeMateria => {
        const mat = todasMaterias.find(m => m.nome.toLowerCase() === nomeMateria.toLowerCase());
        if (mat) materiasFavoritasEl.appendChild(criarCardMateria(mat));
      });

      todasMaterias.forEach(mat => {
        if (!favoritas.some(fav => fav.toLowerCase() === mat.nome.toLowerCase())) {
          materiasOutrasEl.appendChild(criarCardMateria(mat));
        }
      });
    }

    // Abrir modal dos n√≠veis
    function abrirModalNiveis(materia) {
      materiaSelecionada = materia;
      tituloModal.textContent = `N√≠veis de ${materia.nome}`;
      montarListaNiveis(materia);
      modalNiveis.classList.add('active');
      modalNiveis.focus();
    }

    // Montar lista de n√≠veis no modal
    function montarListaNiveis(materia) {
      listaNiveis.innerHTML = '';
      for(let i=1; i<=10; i++){
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.title = `N√≠vel ${i}`;
        btn.setAttribute('aria-label', `Ir para n√≠vel ${i} de ${materia.nome}`);
        btn.tabIndex = 0;
        btn.onclick = () => abrirNivel(materia, i);
        listaNiveis.appendChild(btn);
      }
    }

    // Abrir p√°gina do n√≠vel
    function abrirNivel(materia, nivel) {
      const slug = materia.slug.toUpperCase();
      const url = `nivel${nivel}${slug}.html`;
      window.location.href = url;
    }

    // Fechar modal
    btnFecharModal.onclick = () => {
      modalNiveis.classList.remove('active');
    };
    modalNiveis.onclick = e => {
      if(e.target === modalNiveis){
        modalNiveis.classList.remove('active');
      }
    };
    // Fechar modal com ESC
    document.addEventListener('keydown', e => {
      if(e.key === 'Escape' && modalNiveis.classList.contains('active')){
        modalNiveis.classList.remove('active');
      }
    });

    // Logout
    logoutBtn.onclick = () => {
      localStorage.removeItem('usuarioLogado');
      window.location.href = 'login.html';
    };

    // Fun√ß√£o para adicionar mensagem no chat
    function adicionarMensagem(texto, remetente='bot') {
      if(!texto) return;
      const div = document.createElement('div');
      div.classList.add('message');
      div.classList.add(remetente === 'user' ? 'userMessage' : 'botMessage');
      div.textContent = texto;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Responder chat (simples simula√ß√£o)
    function responderChat(textoUsuario) {
      let resposta = "Desculpe, ainda estou aprendendo a responder isso. Tente outra pergunta!";

      const txt = textoUsuario.toLowerCase();
      if(txt.includes('oi') || txt.includes('ol√°') || txt.includes('ola')) resposta = "Ol√°! Como posso ajudar voc√™ hoje?";
      else if(txt.includes('matem√°tica')) resposta = "Quer aprender matem√°tica? Que tal come√ßarmos com somas e multiplica√ß√µes?";
      else if(txt.includes('portugu√™s')) resposta = "Portugu√™s √© muito legal! Posso ajudar com gram√°tica, leitura e escrita.";
      else if(txt.includes('hist√≥ria')) resposta = "Hist√≥ria √© incr√≠vel! Vamos viajar no tempo e conhecer grandes eventos.";
      else if(txt.includes('geografia')) resposta = "Vamos explorar o mundo juntos na aula de geografia!";
      else if(txt.includes('artes')) resposta = "Artes despertam a criatividade! Quer pintar um quadro virtual?";

      setTimeout(() => {
        adicionarMensagem(resposta, 'bot');
      }, 800);
    }

    // Enviar mensagem chat
    chatSendBtn.onclick = () => {
      const msg = chatInput.value.trim();
      if(!msg) return;
      adicionarMensagem(msg, 'user');
      chatInput.value = '';
      responderChat(msg);
      chatInput.focus();
    };

    // Enviar com Enter
    chatInput.addEventListener('keydown', e => {
      if(e.key === 'Enter'){
        e.preventDefault();
        chatSendBtn.click();
      }
    });

    // Chat toggle
    chatToggleBtn.onclick = () => {
      chatAberto = !chatAberto;
      if(chatAberto){
        chatContainer.classList.add('open');
        chatToggleBtn.setAttribute('aria-pressed', 'true');
        chatContainer.setAttribute('aria-hidden', 'false');
        chatInput.focus();
      } else {
        chatContainer.classList.remove('open');
        chatToggleBtn.setAttribute('aria-pressed', 'false');
        chatContainer.setAttribute('aria-hidden', 'true');
      }
    };

    // Fechar chat
    chatCloseBtn.onclick = () => {
      chatToggleBtn.click();
    };

    // Reconhecimento de voz (Web Speech API)
    if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'pt-BR';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onstart = () => {
        reconhecimentoAtivo = true;
        chatMicBtn.style.backgroundColor = '#388e3c';
        chatMicBtn.setAttribute('aria-pressed', 'true');
        mostrarNotificacao('Microfone ativado. Pode falar!');
      };

      recognition.onresult = e => {
        const transcript = e.results[0][0].transcript;
        chatInput.value = transcript;
        chatInput.focus();
      };

      recognition.onerror = e => {
        mostrarNotificacao('Erro no reconhecimento de voz. Tente novamente.');
      };

      recognition.onend = () => {
        reconhecimentoAtivo = false;
        chatMicBtn.style.backgroundColor = '#4caf50';
        chatMicBtn.setAttribute('aria-pressed', 'false');
      };

      chatMicBtn.onclick = () => {
        if(!chatAberto){
          chatToggleBtn.click();
        }
        if(!reconhecimentoAtivo){
          recognition.start();
        } else {
          recognition.stop();
        }
      };
    } else {
      chatMicBtn.style.display = 'none';
    }

    // Inicializa√ß√£o da p√°gina
    function init() {
      // Se n√£o tem usu√°rio no localStorage, cria um exemplo
      if(!getUsuarioLogado()){
        localStorage.setItem('usuarioLogado', JSON.stringify({
          nome: 'Kaiser',
          materias: ['Matem√°tica', 'Hist√≥ria']
        }));
      }
      const usuario = getUsuarioLogado();
      nomeUsuarioEl.textContent = `Ol√°, ${usuario.nome}!`;
      mostrarMaterias(usuario);

      // Esconde loading e mostra app depois de 1.8s
      setTimeout(() => {
        loadingScreen.style.display = 'none';
        document.getElementById('appContainer').style.display = 'flex';
        mostrarNotificacao(`Bem-vindo(a), ${usuario.nome}! Vamos estudar juntos?`);
      }, 1800);
    }

    window.onload = init;
  </script>
</body>
</html>
