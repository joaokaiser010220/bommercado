<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Estoque Profissional</title>
<style>
/* ======= Layout Geral ======= */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #121212;
  color: #fff;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
}

h1 {
  color: #ffcc00;
  text-shadow: 1px 1px 5px #000;
  margin: 20px 0;
  font-size: 2em;
}

/* ======= Menu Inicial ======= */
#menu {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
}

button {
  padding: 12px 25px;
  border: none;
  border-radius: 12px;
  background-color: #ffcc00;
  color: #000;
  font-size: 1.1em;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.2s ease;
}

button:hover {
  background-color: #ffd633;
  transform: scale(1.05);
}

/* ======= Scanner ======= */
#scanner-container {
  width: 90%;
  max-width: 500px;
  border: 3px solid #ffcc00;
  border-radius: 20px;
  overflow: hidden;
  position: relative;
  background-color: #000;
  box-shadow: 0 0 25px #ffcc00;
  display: none;
}

#reader {
  width: 100%;
  height: 400px;
}

#line {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
  background: rgba(0, 255, 0, 0.85);
  animation: scanLine 2s infinite;
  display: none;
  z-index: 2;
}

@keyframes scanLine {
  0% { top: 0; }
  50% { top: calc(100% - 4px); }
  100% { top: 0; }
}

#feedback {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
  border: 5px solid transparent;
  border-radius: 20px;
  transition: border 0.2s;
  z-index: 3;
}

/* ======= Formulário de Produto ======= */
#formProduto {
  display: none;
  margin-top: 20px;
  background-color: #1f1f1f;
  padding: 20px;
  border-radius: 15px;
  border: 2px solid #ffcc00;
  box-shadow: 0 0 15px #ffcc00;
  width: 90%;
  max-width: 400px;
}

#formProduto input {
  width: 100%;
  padding: 10px;
  margin: 8px 0 15px 0;
  border-radius: 8px;
  border: 1px solid #ffcc00;
  background-color: #000;
  color: #fff;
}

#formProduto button {
  width: 100%;
}

/* ======= Histórico ======= */
#historico {
  display: none;
  margin-top: 20px;
  width: 90%;
  max-width: 700px;
}

#historico table {
  width: 100%;
  border-collapse: collapse;
  background-color: #1f1f1f;
  border-radius: 10px;
  overflow: hidden;
}

#historico th, #historico td {
  border: 1px solid #ffcc00;
  padding: 10px;
  text-align: center;
}

#historico th {
  background-color: #ffcc00;
  color: #000;
}

#historico td.expirando {
  background-color: #ff4444;
  color: #fff;
  font-weight: bold;
}
</style>
<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<h1>Controle de Estoque Profissional</h1>

<div id="menu">
  <button id="btnIniciar">Iniciar Escaneamento</button>
  <button id="btnHistorico">Histórico de Produtos</button>
</div>

<!-- Scanner -->
<div id="scanner-container">
  <div id="reader"></div>
  <div id="line"></div>
  <div id="feedback"></div>
  <button id="btnFecharScanner" style="position:absolute; top:10px; right:10px; background:red; color:#fff;">X</button>
</div>

<!-- Formulário de Produto -->
<div id="formProduto">
  <h3>Informações do Produto</h3>
  <label>Nome:</label>
  <input type="text" id="nome" placeholder="Digite o nome do produto">
  <label>Código:</label>
  <input type="text" id="codigo" readonly>
  <label>Quantidade:</label>
  <input type="number" id="quantidade" min="1" value="1">
  <label>Valor:</label>
  <input type="number" id="valor" min="0" step="0.01">
  <label>Validade:</label>
  <input type="date" id="validade">
  <button id="btnSalvarProduto">Salvar Produto</button>
</div>

<!-- Histórico -->
<div id="historico">
  <h3>Histórico de Produtos</h3>
  <table>
    <thead>
      <tr>
        <th>Nome</th>
        <th>Código</th>
        <th>Quantidade</th>
        <th>Valor</th>
        <th>Subtotal</th>
        <th>Validade</th>
      </tr>
    </thead>
    <tbody id="tbodyHistorico"></tbody>
  </table>
  <h4>Total em Estoque: R$ <span id="totalEstoque">0.00</span></h4>
</div>

<audio id="beep" src="https://www.soundjay.com/button/beep-07.wav"></audio>

<script>
let html5QrcodeScanner;
let ultimoCodigo = "";
let produtoAtual = null;

// ===== Menu =====
document.getElementById('btnIniciar').addEventListener('click', () => {
  document.getElementById('menu').style.display = 'none';
  document.getElementById('scanner-container').style.display = 'block';
  iniciarScanner();
});

document.getElementById('btnHistorico').addEventListener('click', () => {
  document.getElementById('menu').style.display = 'none';
  carregarHistorico();
  document.getElementById('historico').style.display = 'block';
});

// ===== Fechar Scanner =====
document.getElementById('btnFecharScanner').addEventListener('click', () => {
  stopScanner();
  document.getElementById('scanner-container').style.display = 'none';
  document.getElementById('menu').style.display = 'flex';
});

// ===== Scanner =====
function iniciarScanner() {
  const line = document.getElementById('line');
  const feedback = document.getElementById('feedback');
  const beep = document.getElementById('beep');
  line.style.display = 'block';

  beep.play().then(()=>{beep.pause(); beep.currentTime=0;}).catch(()=>{});

  html5QrcodeScanner = new Html5Qrcode("reader");
  html5QrcodeScanner.start(
    { facingMode: "environment" },
    { fps: 15, qrbox: 250 },
    codigo => {
      if(codigo !== ultimoCodigo){
        ultimoCodigo = codigo;
        beep.currentTime = 0; beep.play().catch(()=>{});

        feedback.style.border = "5px solid #00ff00";
        setTimeout(()=>feedback.style.border="5px solid transparent",300);

        produtoAtual = { codigo };
        document.getElementById('scanner-container').style.display='none';
        mostrarFormulario();
      }
    },
    err=>{}
  ).catch(err=>console.error(err));
}

function stopScanner(){
  if(html5QrcodeScanner){
    html5QrcodeScanner.stop().then(()=>{ultimoCodigo="";}).catch(err=>console.error(err));
  }
}

// ===== Formulário =====
function mostrarFormulario(){
  document.getElementById('formProduto').style.display = 'block';
  document.getElementById('codigo').value = produtoAtual.codigo;
}

document.getElementById('btnSalvarProduto').addEventListener('click', async () => {
  const nome = document.getElementById('nome').value.trim();
  const codigo = document.getElementById('codigo').value;
  const quantidade = document.getElementById('quantidade').value;
  const valor = document.getElementById('valor').value;
  const validade = document.getElementById('validade').value;

  if(!nome || !codigo || !quantidade || !valor || !validade){
    alert('Preencha todos os campos!');
    return;
  }

  const novoProduto = { nome, codigo, quantidade:Number(quantidade), valor:Number(valor), validade };

  // Enviar para backend
  try {
    await fetch('/produtos', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(novoProduto)
    });
    alert('Produto salvo com sucesso!');
  } catch(e){
    alert('Erro ao salvar produto!');
    console.error(e);
  }

  produtoAtual=null;
  document.getElementById('formProduto').style.display='none';
  document.getElementById('menu').style.display='flex';
});

// ===== Histórico =====
async function carregarHistorico(){
  try {
    const resp = await fetch('/produtos');
    const produtos = await resp.json();
    const tbody = document.getElementById('tbodyHistorico');
    tbody.innerHTML='';

    let total = 0;
    const hoje = new Date();

    produtos.sort((a,b)=> new Date(a.validade) - new Date(b.validade));

    produtos.forEach(p=>{
      const subtotal = p.quantidade*p.valor;
      total += subtotal;
      const validade = new Date(p.validade);
      const expirando = validade < hoje ? 'expirando' : '';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.nome}</td>
        <td>${p.codigo}</td>
        <td>${p.quantidade}</td>
        <td>R$ ${p.valor.toFixed(2)}</td>
        <td>R$ ${subtotal.toFixed(2)}</td>
        <td class="${expirando}">${p.validade}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById('totalEstoque').innerText = total.toFixed(2);

  } catch(e){
    console.error(e);
  }
}
</script>

</body>
</html>
