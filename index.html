<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cadastro Facial Funcional</title>
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<style>
  body { font-family: Arial; text-align: center; background:#f0f0f0; }
  video, canvas { border:2px solid #444; border-radius:10px; margin:10px; }
  button, input { margin:10px; padding:10px; font-size:16px; }
  #status { font-weight:bold; margin-top:20px; font-size:18px; }
</style>
</head>
<body>
<h1>Cadastro e Verificação Facial</h1>

<input type="text" id="nome" placeholder="Seu nome"><br>
<button id="abrirCamera">Abrir Câmera</button><br>
<video id="video" width="320" height="240" autoplay muted></video>
<canvas id="overlay" width="320" height="240" style="position:absolute; left:0; top:0;"></canvas><br>
<button id="cadastrar">Cadastrar Rosto</button>
<button id="verificar">Verificar Rosto</button>

<div id="status">Status: aguardando...</div>

<script>
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');
const nomeInput = document.getElementById('nome');
const status = document.getElementById('status');

let cameraStarted = false;

// Abrir câmera com botão
document.getElementById('abrirCamera').addEventListener('click', async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video:true });
    video.srcObject = stream;
    cameraStarted = true;
    status.innerText = "Status: Câmera aberta! Posicione o rosto.";
    detectLoop();
  } catch(err) {
    alert("Erro ao abrir a câmera: " + err);
    status.innerText = "Status: erro ao abrir câmera.";
  }
});

// Carregar modelos
async function loadModels() {
  const MODEL_URL = 'https://cdn.jsdelivr.net/npm/face-api.js/weights/';
  await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
  await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
  await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
  status.innerText = "Status: Modelos carregados!";
}
loadModels();

// Loop de detecção
async function detectLoop() {
  if (!cameraStarted) return;
  const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
  ctx.clearRect(0, 0, overlay.width, overlay.height);
  detections.forEach(det => {
    const box = det.detection.box;
    ctx.strokeStyle = 'red';
    ctx.lineWidth = 2;
    ctx.strokeRect(box.x, box.y, box.width, box.height);
  });
  requestAnimationFrame(detectLoop);
}

// Cadastrar rosto
document.getElementById('cadastrar').addEventListener('click', async () => {
  if (!cameraStarted) { alert("Abra a câmera primeiro!"); return; }
  const nome = nomeInput.value.trim();
  if (!nome) { alert("Digite seu nome!"); return; }

  const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                                  .withFaceLandmarks().withFaceDescriptor();
  if (!detection) { status.innerText="❌ Nenhum rosto detectado!"; return; }

  const stored = JSON.parse(localStorage.getItem('faces')) || [];
  stored.push({ nome, descriptor: Array.from(detection.descriptor) });
  localStorage.setItem('faces', JSON.stringify(stored));

  status.innerText = `✅ Rosto de ${nome} cadastrado!`;
  nomeInput.value = '';
});

// Verificar rosto
document.getElementById('verificar').addEventListener('click', async () => {
  if (!cameraStarted) { alert("Abra a câmera primeiro!"); return; }

  const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                                  .withFaceLandmarks().withFaceDescriptor();
  if (!detection) { status.innerText="❌ Nenhum rosto detectado!"; return; }

  const stored = JSON.parse(localStorage.getItem('faces')) || [];
  if (stored.length===0) { status.innerText="❌ Nenhum rosto cadastrado!"; return; }

  let found = false;
  let name = '';
  stored.forEach(face => {
    const distance = faceapi.euclideanDistance(detection.descriptor, new Float32Array(face.descriptor));
    if (distance<0.6) { found=true; name=face.nome; }
  });

  status.innerText = found ? `✅ Rosto reconhecido: ${name}` : "❌ Rosto não reconhecido.";
});
</script>
</body>
</html>
