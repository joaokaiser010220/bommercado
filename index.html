<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Dashboard de Gôndolas</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Roboto', sans-serif; background:#f4f6f8; margin:0; padding:0; }
  header { background:#1e88e5; color:white; padding:15px; text-align:center; font-size:1.5em; }
  main { padding:20px; max-width:1200px; margin:auto; }
  .card { background:white; padding:20px; margin-bottom:20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
  input, button { padding:10px; margin:5px 0; font-size:1em; }
  button { cursor:pointer; background:#1e88e5; color:white; border:none; border-radius:5px; transition:0.3s; }
  button:hover { background:#1565c0; }
  table { border-collapse: collapse; width:100%; margin-top:10px; }
  table, th, td { border:1px solid #ddd; }
  th, td { padding:8px; text-align:center; }
  #qrCodeArea canvas { margin-top:10px; }
  #video { border:1px solid #ddd; border-radius:8px; margin-top:10px; }
  a.downloadQR { display:inline-block; margin-top:10px; color:#1e88e5; text-decoration:none; font-weight:bold; }
  a.downloadQR:hover { text-decoration:underline; }
</style>
</head>
<body>
<header>Dashboard de Gôndolas</header>
<main>

<div id="loginArea" class="card">
  <h3>Login</h3>
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="senha" placeholder="Senha"><br>
  <button onclick="loginEmail()">Entrar com Email</button>
  <button onclick="loginGoogle()">Entrar com Google</button>
</div>

<div id="dashboard" style="display:none;">

  <div class="card">
    <h3>Criar Gôndola</h3>
    <input type="text" id="gondolaId" placeholder="Ex: G1">
    <button onclick="criarGondola()">Criar + Gerar QR Code</button>
    <div id="qrCodeArea"></div>
  </div>

  <div class="card">
    <h3>Escanear Gôndola</h3>
    <video id="video" width="300" height="200" autoplay></video><br>
    <button onclick="abrirCamera()">Abrir Câmera</button>
    <p id="scanResult"></p>
  </div>

  <div class="card" id="produtosCard" style="display:none;">
    <h3>Adicionar Produto - <span id="gondolaAtiva"></span></h3>
    <input type="text" id="produtoNome" placeholder="Nome do Produto"><br>
    <input type="date" id="produtoFabricacao"><br>
    <input type="date" id="produtoVencimento"><br>
    <input type="number" id="produtoQtd" placeholder="Quantidade"><br>
    <button onclick="adicionarProduto()">Adicionar Produto</button>

    <table id="tabelaProdutos">
      <thead><tr><th>Nome</th><th>Fabricação</th><th>Vencimento</th><th>Qtd</th></tr></thead>
      <tbody></tbody>
    </table>

    <button onclick="gerarPDF()">Gerar PDF da Planilha</button>
  </div>

</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getDatabase, ref, set, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBLpRzpTi5AESgpYjZg8KT_yPNpnO6wgcg",
  authDomain: "mercado1-d56e3.firebaseapp.com",
  databaseURL: "https://mercado1-d56e3-default-rtdb.firebaseio.com",
  projectId: "mercado1-d56e3",
  storageBucket: "mercado1-d56e3.firebasestorage.app",
  messagingSenderId: "457032202886",
  appId: "1:457032202886:web:65345f06e9531f91c22f07",
  measurementId: "G-8FM5108MJ5"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let gondolaAtiva = "";

// LOGIN EMAIL/SENHA
window.loginEmail = function(){
  const email=document.getElementById("email").value;
  const senha=document.getElementById("senha").value;
  signInWithEmailAndPassword(auth,email,senha)
  .then(()=>{ document.getElementById("loginArea").style.display="none"; dashboardShow(); })
  .catch(err=>alert("Erro: "+err.message));
};

// LOGIN GOOGLE
window.loginGoogle = function(){
  const provider = new GoogleAuthProvider();
  signInWithPopup(auth,provider)
    .then((result)=>{
      document.getElementById("loginArea").style.display="none";
      dashboardShow();
    })
    .catch(err=>alert("Erro: "+err.message));
};

// Mostrar dashboard
function dashboardShow(){
  document.getElementById("dashboard").style.display="block";
}

// CRIAR GÔNDOLA + QR
window.criarGondola=function(){
  const id=document.getElementById("gondolaId").value.trim();
  if(!id){alert("Digite ID da gôndola");return;}
  set(ref(db,'gondolas/'+id),{produtos:{}})
  .then(()=>{
    alert("Gôndola criada!");
    gondolaAtiva=id;
    gerarQRCode(id);
    document.getElementById("produtosCard").style.display="block";
    document.getElementById("gondolaAtiva").textContent=id;
  });
};

// GERAR QR
function gerarQRCode(text){
  document.getElementById("qrCodeArea").innerHTML="";
  const canvas=document.createElement("canvas");
  document.getElementById("qrCodeArea").appendChild(canvas);
  new QRCode(canvas,{text,width:200,height:200});
  // Download
  canvas.toBlob(blob=>{
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=text+".jpg";
    a.textContent="Baixar QR Code";
    a.className="downloadQR";
    document.getElementById("qrCodeArea").appendChild(a);
  });
}

// ABRIR CAMERA + ESCANEAR QR
window.abrirCamera=function(){
  const video=document.getElementById("video");
  navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
    .then(stream=>{
      video.srcObject=stream;
      video.setAttribute("playsinline",true);
      video.play();
      requestAnimationFrame(tick);
    });

  function tick(){
    if(video.readyState===video.HAVE_ENOUGH_DATA){
      const canvas=document.createElement("canvas");
      canvas.width=video.videoWidth;
      canvas.height=video.videoHeight;
      const ctx=canvas.getContext("2d");
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
      const code=jsQR(imageData.data,imageData.width,imageData.height);
      if(code){
        gondolaAtiva=code.data;
        document.getElementById("scanResult").textContent="Gôndola escaneada: "+code.data;
        document.getElementById("produtosCard").style.display="block";
        document.getElementById("gondolaAtiva").textContent=code.data;
        return;
      }
    }
    requestAnimationFrame(tick);
  }
};

// ADICIONAR PRODUTO
window.adicionarProduto=function(){
  if(!gondolaAtiva){alert("Nenhuma gôndola ativa");return;}
  const nome=document.getElementById("produtoNome").value;
  const fab=document.getElementById("produtoFabricacao").value;
  const ven=document.getElementById("produtoVencimento").value;
  const qtd=parseInt(document.getElementById("produtoQtd").value);
  if(!nome||!fab||!ven||!qtd){alert("Preencha todos os campos");return;}
  const novoProdutoRef=push(ref(db,'gondolas/'+gondolaAtiva+'/produtos'));
  set(novoProdutoRef,{nome,fabricacao:fab,vencimento:ven,quantidade:qtd})
    .then(()=>atualizarTabela(nome,fab,ven,qtd));
};

function atualizarTabela(nome,fab,ven,qtd){
  const tbody=document.querySelector("#tabelaProdutos tbody");
  const tr=document.createElement("tr");
  tr.innerHTML=`<td>${nome}</td><td>${fab}</td><td>${ven}</td><td>${qtd}</td>`;
  tbody.appendChild(tr);
}

// GERAR PDF
window.gerarPDF=function(){
  import("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js").then(html2pdf=>{
    const element=document.createElement("div");
    element.innerHTML=document.getElementById("tabelaProdutos").outerHTML;
    html2pdf.default().from(element).set({margin:0.5,filename:"planilha_gondola.pdf",html2canvas:{scale:2}}).save();
  });
};
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</body>
</html>
