<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz Multiplayer</title>
<style>
  body { font-family: Arial, sans-serif; background: #f0f8ff; padding: 20px; }
  #app > div { margin-bottom: 20px; }
  button { padding: 10px 15px; margin: 5px; cursor: pointer; }
  input, select { padding: 8px; font-size: 16px; }
  .hidden { display: none; }
  .materia-btn { padding: 10px; margin: 5px; border: 1px solid #0077cc; border-radius: 5px; cursor: pointer; }
  .materia-btn.selected { background-color: #0077cc; color: white; }
</style>
</head>
<body>

<div id="app">
  <!-- Login -->
  <div id="login-screen">
    <h2>Bem-vindo ao Quiz</h2>
    <input id="input-nome" placeholder="Seu nome" />
    <button id="btn-login">Entrar</button>
  </div>

  <!-- Menu -->
  <div id="menu-screen" class="hidden">
    <h2>Olá, <span id="nome-usuario"></span></h2>
    <button id="btn-criar-sala">Criar Sala</button>
    <br/>
    <input id="input-codigo-sala" placeholder="Código da sala" maxlength="6" style="text-transform:uppercase" />
    <button id="btn-entrar-sala">Entrar na Sala</button>
  </div>

  <!-- Sala -->
  <div id="sala-screen" class="hidden">
    <h2>Sala: <span id="codigo-sala"></span></h2>
    <p>Status: <span id="status-sala"></span></p>
    <p>Host: <span id="host-sala"></span></p>
    <p>Participantes:</p>
    <ul id="lista-participantes"></ul>

    <div id="host-actions" class="hidden">
      <button id="btn-iniciar-votacao">Iniciar Votação</button>
    </div>

    <div id="votacao-screen" class="hidden">
      <h3>Vote na matéria para o quiz</h3>
      <div id="materias-lista"></div>
      <p>Tempo para votar: <span id="timer-votacao">300</span> segundos</p>
      <button id="btn-enviar-voto" disabled>Enviar Voto</button>
    </div>

    <div id="quiz-screen" class="hidden">
      <h3>Quiz: <span id="materia-quiz"></span></h3>
      <div id="pergunta-container"></div>
      <button id="btn-proxima-pergunta" disabled>Próxima</button>
    </div>

    <div id="resultado-screen" class="hidden">
      <h3>Resultados</h3>
      <p>Você acertou <span id="acertos"></span> de <span id="total-perguntas"></span> perguntas.</p>
      <button id="btn-voltar-menu">Voltar ao menu</button>
    </div>

    <div id="ranking-screen" class="hidden">
      <h3>Ranking da sala</h3>
      <ol id="ranking-lista"></ol>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  // CONFIGURAÇÃO FIREBASE - USANDO APENAS LINK DO DATABASE
  const firebaseConfig = {
    databaseURL: "https://sapichoes1-default-rtdb.firebaseio.com/"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Variáveis gerais
  let usuario = null;
  let codigoSala = null;
  let salaData = null;
  let materiaVencedora = null;
  let votoSelecionado = null;
  let perguntas = null;
  let perguntaIndex = 0;
  let respostasUsuario = [];

  // Perguntas JSON de exemplo (exemplo só 3 perguntas por matéria)
  const perguntasJSON = {
    "Matemática": [
      { "pergunta": "Quanto é 2 + 2?", "opcoes": ["3", "4", "5", "6"], "resposta": 1 },
      { "pergunta": "Qual o resultado de 5 x 3?", "opcoes": ["15", "10", "8", "20"], "resposta": 0 },
      { "pergunta": "Quanto é 10 dividido por 2?", "opcoes": ["2", "5", "10", "20"], "resposta": 1 }
    ],
    "Português": [
      { "pergunta": "Qual é a forma correta?", "opcoes": ["Mau", "Mal"], "resposta": 1 },
      { "pergunta": "Plural de lápis é?", "opcoes": ["Lápis", "Lápises"], "resposta": 0 },
      { "pergunta": "Sinônimo de feliz?", "opcoes": ["Triste", "Contente", "Bravo", "Cansado"], "resposta": 1 }
    ],
    "História": [
      { "pergunta": "Quem descobriu o Brasil?", "opcoes": ["Pedro Álvares Cabral", "Cristóvão Colombo"], "resposta": 0 },
      { "pergunta": "Em que ano foi a Proclamação da República?", "opcoes": ["1889", "1822"], "resposta": 0 },
      { "pergunta": "Quem foi Dom Pedro I?", "opcoes": ["Imperador do Brasil", "Presidente do Brasil"], "resposta": 0 }
    ]
  };

  // Funções utilitárias
  function gerarCodigoSala() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    let codigo = "";
    for(let i=0; i<6; i++) {
      codigo += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return codigo;
  }

  function mostrarElemento(id) {
    document.getElementById(id).classList.remove("hidden");
  }
  function esconderElemento(id) {
    document.getElementById(id).classList.add("hidden");
  }

  // Login
  document.getElementById("btn-login").onclick = () => {
    const nome = document.getElementById("input-nome").value.trim();
    if(nome.length < 3) {
      alert("Digite um nome válido");
      return;
    }
    usuario = nome;
    document.getElementById("nome-usuario").innerText = usuario;
    esconderElemento("login-screen");
    mostrarElemento("menu-screen");
  };

  // Criar sala
  document.getElementById("btn-criar-sala").onclick = async () => {
    const novoCodigo = gerarCodigoSala();
    codigoSala = novoCodigo;

    const materias = Object.keys(perguntasJSON); // todas matérias do JSON

    const sala = {
      host: usuario,
      materias: materias,
      participantes: [usuario],
      status: "aguardando"
    };

    await db.ref("salas/" + codigoSala).set(sala);
    salaData = sala;

    mostrarSala();
    ouvirSala();
  };

  // Entrar na sala
  document.getElementById("btn-entrar-sala").onclick = async () => {
    const codigo = document.getElementById("input-codigo-sala").value.trim().toUpperCase();
    if(codigo.length !== 6) {
      alert("Código inválido");
      return;
    }

    const salaSnap = await db.ref("salas/" + codigo).get();
    if(!salaSnap.exists()) {
      alert("Sala não encontrada");
      return;
    }

    const salaObj = salaSnap.val();

    if(!salaObj.participantes) salaObj.participantes = [];
    if(!salaObj.participantes.includes(usuario)) {
      salaObj.participantes.push(usuario);
      await db.ref("salas/" + codigo + "/participantes").set(salaObj.participantes);
    }

    codigoSala = codigo;
    salaData = salaObj;

    mostrarSala();
    ouvirSala();
  };

  function mostrarSala() {
    esconderElemento("menu-screen");
    mostrarElemento("sala-screen");

    document.getElementById("codigo-sala").innerText = codigoSala;
    document.getElementById("host-sala").innerText = salaData.host;
    document.getElementById("status-sala").innerText = salaData.status;

    atualizarParticipantes();

    if(usuario === salaData.host) {
      mostrarElemento("host-actions");
    } else {
      esconderElemento("host-actions");
    }

    if(salaData.status === "aguardando") {
      esconderElemento("votacao-screen");
      esconderElemento("quiz-screen");
      esconderElemento("resultado-screen");
      esconderElemento("ranking-screen");
    } else if(salaData.status === "votacao") {
      mostrarTelaVotacao();
    } else if(salaData.status === "quiz") {
      materiaVencedora = salaData.materiaSelecionada;
      iniciarQuiz();
    } else if(salaData.status === "final") {
      mostrarRanking();
    }
  }

  function atualizarParticipantes() {
    const ul = document.getElementById("lista-participantes");
    ul.innerHTML = "";
    if(salaData.participantes) {
      salaData.participantes.forEach(p => {
        const li = document.createElement("li");
        li.innerText = p;
        ul.appendChild(li);
      });
    }
  }

  // Ouvir sala em tempo real
  function ouvirSala() {
    db.ref("salas/" + codigoSala).on("value", snapshot => {
      salaData = snapshot.val();
      if(!salaData) {
        alert("Sala foi encerrada");
        location.reload();
        return;
      }
      document.getElementById("status-sala").innerText = salaData.status;
      atualizarParticipantes();

      if(salaData.status === "votacao") {
        mostrarTelaVotacao();
      } else {
        esconderElemento("votacao-screen");
      }

      if(salaData.status === "quiz" && salaData.materiaSelecionada) {
        materiaVencedora = salaData.materiaSelecionada;
        if(document.getElementById("quiz-screen").classList.contains("hidden")) {
          iniciarQuiz();
        }
      }

      if(salaData.status === "final") {
        mostrarRanking();
      } else {
        esconderElemento("ranking-screen");
      }
    });
  }

  // Host inicia votação
  document.getElementById("btn-iniciar-votacao").onclick = async () => {
    if(!codigoSala) return;
    await db.ref("salas/" + codigoSala + "/status").set("votacao");
    await db.ref("salas/" + codigoSala + "/votos").set({});
  };

  // Tela votação
  let timerInterval = null;
  function mostrarTelaVotacao() {
    mostrarElemento("votacao-screen");
    esconderElemento("quiz-screen");
    esconderElemento("resultado-screen");
    esconderElemento("ranking-screen");

    const materiasDiv = document.getElementById("materias-lista");
    materiasDiv.innerHTML = "";
    votoSelecionado = null;
    document.getElementById("btn-enviar-voto").disabled = true;

    salaData.materias.forEach(mat => {
      const btn = document.createElement("button");
      btn.innerText = mat;
      btn.classList.add("materia-btn");
      btn.onclick = () => {
        document.querySelectorAll(".materia-btn").forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        votoSelecionado = mat;
        document.getElementById("btn-enviar-voto").disabled = false;
      };
      materiasDiv.appendChild(btn);
    });

    let tempo = 300;
    document.getElementById("timer-votacao").innerText = tempo;
    if(timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      tempo--;
      document.getElementById("timer-votacao").innerText = tempo;
      if(tempo <= 0) {
        clearInterval(timerInterval);
        finalizarVotacao();
      }
    }, 1000);

    // Ouvir votos
    db.ref("salas/" + codigoSala + "/votos").on("value", snapshot => {
      const votos = snapshot.val() || {};
      const qtdeVotos = Object.keys(votos).length;
      const qtdeParticipantes = salaData.participantes.length;
      if(qtdeVotos >= qtdeParticipantes) {
        clearInterval(timerInterval);
        finalizarVotacao();
      }
    });
  }

  // Enviar voto
  document.getElementById("btn-enviar-voto").onclick = async () => {
    if(!votoSelecionado) return alert("Selecione uma matéria");
    const votoPath = `salas/${codigoSala}/votos/${usuario}`;
    await db.ref(votoPath).set(votoSelecionado);
    document.getElementById("btn-enviar-voto").disabled = true;
    alert("Voto enviado! Aguarde o fim da votação.");
  };

  // Finalizar votação
  async function finalizarVotacao() {
    const votosSnap = await db.ref("salas/" + codigoSala + "/votos").get();
    const votos = votosSnap.val() || {};
    const contagem = {};
    Object.values(votos).forEach(m => {
      contagem[m] = (contagem[m] || 0) + 1;
    });
    let maxVotos = 0;
    let materiaEscolhida = null;
    for(let mat in contagem) {
      if(contagem[mat] > maxVotos) {
        maxVotos = contagem[mat];
        materiaEscolhida = mat;
      }
    }
    if(!materiaEscolhida) {
      alert("Nenhuma matéria votada, selecionando Matemática por padrão");
      materiaEscolhida = "Matemática";
    }
    await db.ref("salas/" + codigoSala + "/materiaSelecionada").set(materiaEscolhida);
    await db.ref("salas/" + codigoSala + "/status").set("quiz");
  }

  // Quiz
  document.getElementById("btn-proxima-pergunta").onclick = () => {
    perguntaIndex++;
    mostrarPergunta();
  };

  function iniciarQuiz() {
    esconderElemento("votacao-screen");
    mostrarElemento("quiz-screen");
    esconderElemento("resultado-screen");
    esconderElemento("ranking-screen");

    document.getElementById("materia-quiz").innerText = materiaVencedora;

    perguntas = perguntasJSON[materiaVencedora];
    perguntaIndex = 0;
    respostasUsuario = [];

    mostrarPergunta();
  }

  function mostrarPergunta() {
    const cont = document.getElementById("pergunta-container");
    cont.innerHTML = "";

    if(perguntaIndex >= perguntas.length) {
      finalizarQuiz();
      return;
    }

    const p = perguntas[perguntaIndex];
    const perguntaEl = document.createElement("p");
    perguntaEl.innerText = `Pergunta ${perguntaIndex + 1}: ${p.pergunta}`;
    cont.appendChild(perguntaEl);

    p.opcoes.forEach((op, i) => {
      const btn = document.createElement("button");
      btn.innerText = op;
      btn.style.display = "block";
      btn.style.margin = "5px 0";
      btn.onclick = () => {
        respostasUsuario[perguntaIndex] = i;
        // Desmarca todos
        Array.from(cont.querySelectorAll("button")).forEach(b => b.style.backgroundColor = "");
        btn.style.backgroundColor = "#0077cc";
        btn.style.color = "white";
        document.getElementById("btn-proxima-pergunta").disabled = false;
      };
      cont.appendChild(btn);
    });

    document.getElementById("btn-proxima-pergunta").disabled = true;
  }

  async function finalizarQuiz() {
    esconderElemento("quiz-screen");
    mostrarElemento("resultado-screen");

    let acertos = 0;
    perguntas.forEach((p, i) => {
      if(respostasUsuario[i] === p.resposta) acertos++;
    });

    document.getElementById("acertos").innerText = acertos;
    document.getElementById("total-perguntas").innerText = perguntas.length;

    // Salvar resultado no firebase
    const resultadoPath = `salas/${codigoSala}/resultados/${usuario}`;
    await db.ref(resultadoPath).set({ acertos });

    // Atualizar status sala para final se quiser (host pode controlar)
    // Para exemplo, vamos atualizar após resultado
    if(usuario === salaData.host) {
      await db.ref("salas/" + codigoSala + "/status").set("final");
    }
  }

  // Ranking
  async function mostrarRanking() {
    esconderElemento("votacao-screen");
    esconderElemento("quiz-screen");
    esconderElemento("resultado-screen");
    mostrarElemento("ranking-screen");

    const rankingLista = document.getElementById("ranking-lista");
    rankingLista.innerHTML = "";

    const resultadosSnap = await db.ref(`salas/${codigoSala}/resultados`).get();
    const resultados = resultadosSnap.val() || {};

    // Criar array para ordenar
    const arr = Object.entries(resultados).map(([user, res]) => ({ user, acertos: res.acertos }));
    arr.sort((a,b) => b.acertos - a.acertos);

    arr.forEach(r => {
      const li = document.createElement("li");
      li.innerText = `${r.user}: ${r.acertos} acertos`;
      rankingLista.appendChild(li);
    });
  }

  // Voltar ao menu após resultado
  document.getElementById("btn-voltar-menu").onclick = () => {
    location.reload();
  };

</script>

</body>
</html>
