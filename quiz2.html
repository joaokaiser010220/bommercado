<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz Online com Votação - Pequenos Gênios</title>
<style>
  /* Reset básico */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; 
    font-family: 'Comic Neue', cursive, 'Comic Sans MS', cursive, sans-serif;
    background: #d0f0c0;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    color: #2e7d32;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  header {
    background: #4caf50;
    padding: 16px 20px;
    color: white;
    font-weight: 700;
    font-size: 1.7rem;
    text-align: center;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    font-family: 'Fredoka One', cursive, 'Comic Neue', cursive;
  }
  main {
    flex: 1;
    max-width: 480px;
    margin: 20px auto 40px;
    background: white;
    border-radius: 20px;
    padding: 25px 20px 30px;
    box-shadow: 0 5px 18px rgba(0,0,0,0.1);
  }
  h2 {
    text-align: center;
    font-weight: 700;
    margin-bottom: 20px;
    font-family: 'Fredoka One', cursive, 'Comic Neue', cursive;
    color: #2e7d32;
  }
  label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
  }
  input[type=text] {
    width: 100%;
    padding: 12px 15px;
    margin-bottom: 18px;
    border: 2.5px solid #4caf50;
    border-radius: 14px;
    font-size: 1.1rem;
    transition: border-color 0.3s ease;
    font-family: 'Comic Neue', cursive, 'Comic Sans MS', cursive, sans-serif;
  }
  input[type=text]:focus {
    border-color: #2e7d32;
    outline: none;
  }
  button {
    width: 100%;
    background: #4caf50;
    color: white;
    font-size: 1.3rem;
    font-weight: 700;
    padding: 14px 0;
    border: none;
    border-radius: 24px;
    cursor: pointer;
    box-shadow: 0 6px 12px rgba(46,125,50,0.5);
    transition: background-color 0.3s ease;
    font-family: 'Fredoka One', cursive, 'Comic Neue', cursive;
  }
  button:hover, button:focus {
    background: #2e7d32;
    outline: none;
  }
  .flex-row {
    display: flex;
    gap: 20px;
    margin-bottom: 25px;
  }
  .flex-row button {
    flex: 1;
  }
  .hidden {
    display: none;
  }
  .message-box {
    background: #ffecb3;
    border-radius: 14px;
    padding: 12px 15px;
    margin-bottom: 18px;
    font-weight: 700;
    color: #5d4037;
    text-align: center;
  }
  /* Lista de matérias para votação */
  .materias-lista {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
    margin-bottom: 25px;
  }
  .materia-item {
    background: #a5d6a7;
    padding: 12px 18px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 700;
    color: #1b5e20;
    user-select: none;
    flex: 1 0 40%;
    text-align: center;
    box-shadow: 0 3px 8px rgba(0,0,0,0.12);
    transition: background-color 0.3s ease;
    min-width: 120px;
  }
  .materia-item.selected {
    background: #4caf50;
    color: white;
  }
  .materia-item.disabled {
    background: #ccc;
    color: #777;
    cursor: not-allowed;
    box-shadow: none;
  }
  /* Código sala fixo */
  #codigoSalaExibido {
    background: #4caf50;
    color: white;
    font-weight: 700;
    font-size: 1.3rem;
    padding: 10px 14px;
    border-radius: 14px;
    text-align: center;
    margin-bottom: 20px;
    user-select: all;
  }
  /* Status geral da sala */
  #statusVotacao, #resultadoVotacao {
    font-weight: 700;
    text-align: center;
    font-size: 1.2rem;
    margin-bottom: 20px;
    color: #2e7d32;
  }
  /* Confirmação do voto */
  #confirmacaoVoto {
    background: #c8e6c9;
    padding: 15px;
    border-radius: 20px;
    margin-bottom: 20px;
    text-align: center;
    font-weight: 700;
    color: #2e7d32;
  }
  /* Botões de confirmação */
  .btnConfirm, .btnCancel {
    font-weight: 700;
    font-size: 1.1rem;
    padding: 10px 25px;
    margin: 8px;
    border-radius: 20px;
    border: none;
    cursor: pointer;
    user-select: none;
  }
  .btnConfirm {
    background: #4caf50;
    color: white;
    box-shadow: 0 5px 10px rgba(46,125,50,0.5);
  }
  .btnConfirm:hover {
    background: #2e7d32;
  }
  .btnCancel {
    background: #ccc;
    color: #555;
  }
  .btnCancel:hover {
    background: #999;
  }
  /* Responsivo */
  @media(max-width:480px) {
    main {
      margin: 10px 12px 30px;
      padding: 20px 12px 25px;
    }
    .materia-item {
      flex: 1 0 100%;
    }
  }
</style>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Comic+Neue:wght@700&display=swap" rel="stylesheet" />
</head>
<body>

<header>Quiz Online - Pequenos Gênios</header>

<main>

  <!-- Tela Inicial com 2 botões -->
  <section id="telaInicial">
    <div class="flex-row">
      <button id="btnCriarSala">Criar Quiz Online</button>
      <button id="btnEntrarSala">Entrar na Sala</button>
    </div>
  </section>

  <!-- Tela Criar Sala -->
  <section id="telaCriarSala" class="hidden">
    <h2>Criar Sala</h2>
    <label for="inputNomeHost">Seu nome (host):</label>
    <input id="inputNomeHost" type="text" placeholder="Digite seu nome" autocomplete="off" />
    <div id="msgCriarSala" class="message-box hidden"></div>
    <button id="btnGerarSala">Gerar código e criar sala</button>
    <button id="btnVoltarCriar" style="margin-top:12px; background:#ccc; color:#2e7d32;">Voltar</button>
  </section>

  <!-- Tela Entrar Sala -->
  <section id="telaEntrarSala" class="hidden">
    <h2>Entrar na Sala</h2>
    <label for="inputCodigoSala">Código da sala:</label>
    <input id="inputCodigoSala" type="text" maxlength="6" placeholder="Ex: G6VYEE" autocomplete="off" />
    <label for="inputNomeParticipante">Seu nome:</label>
    <input id="inputNomeParticipante" type="text" placeholder="Digite seu nome" autocomplete="off" />
    <div id="msgEntrarSala" class="message-box hidden"></div>
    <button id="btnEntrarConfirmar">Entrar</button>
    <button id="btnVoltarEntrar" style="margin-top:12px; background:#ccc; color:#2e7d32;">Voltar</button>
  </section>

  <!-- Tela votação (participante e host) -->
  <section id="telaVotacao" class="hidden">
    <h2>Votação das Matérias</h2>
    <div id="codigoSalaExibido" title="Código da sala"></div>
    <div id="statusVotacao">Escolha uma matéria para votar:</div>
    <div class="materias-lista" id="listaMaterias"></div>
    <div id="confirmacaoVoto" class="hidden"></div>
    <div id="resultadoVotacao" class="hidden"></div>
    <button id="btnSairFila" style="background:#ccc; color:#2e7d32; margin-top:12px;">Sair da sala</button>
  </section>

</main>

<script>
  const FIREBASE_SALAS = "https://sapichoes1-default-rtdb.firebaseio.com/salas";

  // Elementos
  const telaInicial = document.getElementById("telaInicial");
  const telaCriarSala = document.getElementById("telaCriarSala");
  const telaEntrarSala = document.getElementById("telaEntrarSala");
  const telaVotacao = document.getElementById("telaVotacao");

  const inputNomeHost = document.getElementById("inputNomeHost");
  const btnGerarSala = document.getElementById("btnGerarSala");
  const msgCriarSala = document.getElementById("msgCriarSala");
  const btnVoltarCriar = document.getElementById("btnVoltarCriar");

  const inputCodigoSala = document.getElementById("inputCodigoSala");
  const inputNomeParticipante = document.getElementById("inputNomeParticipante");
  const btnEntrarConfirmar = document.getElementById("btnEntrarConfirmar");
  const msgEntrarSala = document.getElementById("msgEntrarSala");
  const btnVoltarEntrar = document.getElementById("btnVoltarEntrar");

  const listaMaterias = document.getElementById("listaMaterias");
  const statusVotacao = document.getElementById("statusVotacao");
  const confirmacaoVoto = document.getElementById("confirmacaoVoto");
  const resultadoVotacao = document.getElementById("resultadoVotacao");
  const btnSairFila = document.getElementById("btnSairFila");
  const codigoSalaExibido = document.getElementById("codigoSalaExibido");

  const todasMaterias = ["Matemática", "Português", "História", "Geografia", "Ciências", "Inglês", "Artes"];

  let codigoSalaAtual = null;
  let nomeAtual = null;
  let votou = false;
  let votoAtual = null;
  let participantesNaSala = [];

  let pollingInterval = null;

  // Gera código aleatório para sala
  function gerarCodigoSala() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    let codigo = "";
    for(let i=0; i<6; i++) {
      codigo += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return codigo;
  }

  // Mostra só a tela passada, esconde as outras
  function mostrarTela(tela) {
    [telaInicial, telaCriarSala, telaEntrarSala, telaVotacao].forEach(t => {
      t.classList.add("hidden");
    });
    tela.classList.remove("hidden");
  }

  // Cria a sala no Firebase
  async function criarSala(nomeHost) {
    const codigo = gerarCodigoSala();
    const novaSala = {
      host: nomeHost,
      materias: todasMaterias,
      status: "votacao",
      participantes: [],
      votos: {}
    };
    const url = `${FIREBASE_SALAS}/${codigo}.json`;
    const response = await fetch(url, {
      method: "PUT",
      body: JSON.stringify(novaSala),
      headers: {"Content-Type": "application/json"}
    });
    if (!response.ok) throw new Error("Erro ao criar sala");
    return codigo;
  }

  // Busca sala no Firebase
  async function buscarSala(codigo) {
    const url = `${FIREBASE_SALAS}/${codigo}.json`;
    const response = await fetch(url);
    if (!response.ok) throw new Error("Erro ao acessar sala");
    const sala = await response.json();
    return sala;
  }

  // Atualiza dados da sala no Firebase
  async function atualizarSala(codigo, dados) {
    const url = `${FIREBASE_SALAS}/${codigo}.json`;
    const response = await fetch(url, {
      method: "PATCH",
      body: JSON.stringify(dados),
      headers: {"Content-Type": "application/json"}
    });
    if (!response.ok) throw new Error("Erro ao atualizar sala");
  }

  // Adiciona participante na lista da sala, se não estiver lá
  async function adicionarParticipante(codigo, nome) {
    const sala = await buscarSala(codigo);
    if (!sala.participantes) sala.participantes = [];
    if (!sala.participantes.includes(nome)) {
      sala.participantes.push(nome);
      await atualizarSala(codigo, {participantes: sala.participantes});
    }
  }

  // Remove participante da sala (usado ao sair)
  async function removerParticipante(codigo, nome) {
    const sala = await buscarSala(codigo);
    if (!sala.participantes) sala.participantes = [];
    const index = sala.participantes.indexOf(nome);
    if (index !== -1) {
      sala.participantes.splice(index, 1);
      await atualizarSala(codigo, {participantes: sala.participantes});
    }
  }

  // Monta a lista de matérias para votação, mostrando votos se existirem
  function montarListaMaterias(votos = {}, disabled = false) {
    listaMaterias.innerHTML = "";
    todasMaterias.forEach(materia => {
      const btn = document.createElement("div");
      btn.className = "materia-item";
      btn.textContent = `${materia} ${votos[materia] ? `(${votos[materia]})` : ""}`;
      if (disabled) {
        btn.classList.add("disabled");
      } else {
        btn.addEventListener("click", () => confirmarVoto(materia));
      }
      listaMaterias.appendChild(btn);
    });
  }

  // Confirma voto com botões bonitos
  function confirmarVoto(materia) {
    if (votou) return;
    confirmacaoVoto.innerHTML = `
      <p>Confirma seu voto em <strong>${materia}</strong>?</p>
      <button class="btnConfirm" id="btnConfirmaVoto">Sim</button>
      <button class="btnCancel" id="btnCancelaVoto">Cancelar</button>
    `;
    confirmacaoVoto.classList.remove("hidden");

    document.getElementById("btnConfirmaVoto").addEventListener("click", () => enviarVoto(materia));
    document.getElementById("btnCancelaVoto").addEventListener("click", () => {
      confirmacaoVoto.classList.add("hidden");
      confirmacaoVoto.innerHTML = "";
    });
  }

  // Envia voto para o Firebase, incrementando a contagem
  async function enviarVoto(materia) {
    if (votou) return;
    try {
      const sala = await buscarSala(codigoSalaAtual);
      const votos = sala.votos || {};

      // Incrementa voto para matéria
      if (!votos[materia]) votos[materia] = 0;
      votos[materia]++;

      await atualizarSala(codigoSalaAtual, {votos});
      votou = true;
      votoAtual = materia;

      confirmacaoVoto.innerHTML = `<p style="color:green;">Voto enviado em <strong>${materia}</strong>!</p>`;
      montarListaMaterias(votos, true);
      statusVotacao.textContent = "Você já votou. Aguardando resultado...";
    } catch {
      confirmacaoVoto.innerHTML = `<p style="color:red;">Erro ao enviar voto. Tente novamente.</p>`;
    }
  }

  // Atualiza tela da votação a cada 2 segundos
  async function atualizarVotacao() {
    try {
      if (!codigoSalaAtual) return;
      const sala = await buscarSala(codigoSalaAtual);
      if (!sala) return;

      participantesNaSala = sala.participantes || [];

      montarListaMaterias(sala.votos || {}, votou);

      // Contagem total votos
      const totalVotos = sala.votos ? Object.values(sala.votos).reduce((a,b) => a+b, 0) : 0;

      // Se todos votaram e tem participantes, mostra resultado
      if (totalVotos >= participantesNaSala.length && participantesNaSala.length > 0) {
        mostrarResultado(sala.votos);
      } else {
        resultadoVotacao.classList.add("hidden");
        if (!votou) {
          statusVotacao.textContent = "Escolha uma matéria para votar:";
          confirmacaoVoto.classList.add("hidden");
        }
      }
    } catch {
      // Ignora erros simples
    }
  }

  // Mostra resultado da votação com votos ordenados
  function mostrarResultado(votos) {
    confirmacaoVoto.classList.add("hidden");
    resultadoVotacao.classList.remove("hidden");
    statusVotacao.textContent = "Resultado da votação:";

    const resultadoOrdenado = Object.entries(votos || {}).sort((a,b) => b[1] - a[1]);

    if (resultadoOrdenado.length === 0) {
      resultadoVotacao.textContent = "Nenhum voto registrado.";
      return;
    }

    let textoResultado = resultadoOrdenado.map(([mat, qnt]) => `${mat}: ${qnt} voto${qnt !== 1 ? 's' : ''}`).join(" | ");
    resultadoVotacao.textContent = textoResultado;
  }

  // Inicia polling para atualizar votação
  function iniciarPolling() {
    if (pollingInterval) clearInterval(pollingInterval);
    pollingInterval = setInterval(atualizarVotacao, 2000);
  }

  // Eventos dos botões

  // Mostrar tela criar sala
  document.getElementById("btnCriarSala").addEventListener("click", () => {
    mostrarTela(telaCriarSala);
  });

  // Mostrar tela entrar na sala
  document.getElementById("btnEntrarSala").addEventListener("click", () => {
    mostrarTela(telaEntrarSala);
  });

  // Voltar da criar sala para inicial
  btnVoltarCriar.addEventListener("click", () => {
    mostrarTela(telaInicial);
    msgCriarSala.classList.add("hidden");
    inputNomeHost.value = "";
  });

  // Voltar da entrar sala para inicial
  btnVoltarEntrar.addEventListener("click", () => {
    mostrarTela(telaInicial);
    msgEntrarSala.classList.add("hidden");
    inputCodigoSala.value = "";
    inputNomeParticipante.value = "";
  });

  // Criar sala no Firebase
  btnGerarSala.addEventListener("click", async () => {
    const nomeHost = inputNomeHost.value.trim();
    msgCriarSala.classList.add("hidden");
    if (!nomeHost) {
      msgCriarSala.textContent = "Digite seu nome para criar a sala.";
      msgCriarSala.classList.remove("hidden");
      return;
    }
    btnGerarSala.disabled = true;
    btnGerarSala.textContent = "Criando sala...";
    try {
      const codigo = await criarSala(nomeHost);
      codigoSalaAtual = codigo;
      nomeAtual = nomeHost;
      votou = false;
      votoAtual = null;
      mostrarTela(telaVotacao);
      statusVotacao.textContent = "Escolha uma matéria para votar:";
      confirmacaoVoto.classList.add("hidden");
      resultadoVotacao.classList.add("hidden");
      participantesNaSala = [];
      iniciarPolling();
      codigoSalaExibido.textContent = `Código da Sala: ${codigoSalaAtual}`;
    } catch {
      msgCriarSala.textContent = "Erro ao criar sala. Tente novamente.";
      msgCriarSala.classList.remove("hidden");
    } finally {
      btnGerarSala.disabled = false;
      btnGerarSala.textContent = "Gerar código e criar sala";
    }
  });

  // Entrar na sala
  btnEntrarConfirmar.addEventListener("click", async () => {
    const codigo = inputCodigoSala.value.trim().toUpperCase();
    const nomeParticipante = inputNomeParticipante.value.trim();
    msgEntrarSala.classList.add("hidden");
    if (!codigo || codigo.length !== 6) {
      msgEntrarSala.textContent = "Digite um código de sala válido (6 caracteres).";
      msgEntrarSala.classList.remove("hidden");
      return;
    }
    if (!nomeParticipante) {
      msgEntrarSala.textContent = "Digite seu nome para entrar na sala.";
      msgEntrarSala.classList.remove("hidden");
      return;
    }
    btnEntrarConfirmar.disabled = true;
    btnEntrarConfirmar.textContent = "Entrando...";
    try {
      const sala = await buscarSala(codigo);
      if (!sala) {
        msgEntrarSala.textContent = "Sala não encontrada.";
        msgEntrarSala.classList.remove("hidden");
        btnEntrarConfirmar.disabled = false;
        btnEntrarConfirmar.textContent = "Entrar";
        return;
      }
      await adicionarParticipante(codigo, nomeParticipante);
      codigoSalaAtual = codigo;
      nomeAtual = nomeParticipante;
      votou = false;
      votoAtual = null;
      mostrarTela(telaVotacao);
      confirmacaoVoto.classList.add("hidden");
      resultadoVotacao.classList.add("hidden");
      statusVotacao.textContent = "Escolha uma matéria para votar:";
      participantesNaSala = [];
      iniciarPolling();
      codigoSalaExibido.textContent = `Código da Sala: ${codigoSalaAtual}`;
    } catch {
      msgEntrarSala.textContent = "Erro ao entrar na sala. Tente novamente.";
      msgEntrarSala.classList.remove("hidden");
    } finally {
      btnEntrarConfirmar.disabled = false;
      btnEntrarConfirmar.textContent = "Entrar";
    }
  });

  // Sair da sala
  btnSairFila.addEventListener("click", async () => {
    if (!codigoSalaAtual || !nomeAtual) {
      resetarTudo();
      return;
    }

    // Se for host e votação ativa, impede sair para evitar bug
    try {
      const sala = await buscarSala(codigoSalaAtual);
      if (sala.host === nomeAtual && sala.status === "votacao") {
        alert("Host não pode sair enquanto a votação está ativa.");
        return;
      }
    } catch {
      // Se erro, permitir sair
    }

    try {
      await removerParticipante(codigoSalaAtual, nomeAtual);
    } catch {
      // Ignora erro na remoção
    }
    resetarTudo();
  });

  // Resetar variáveis e voltar para tela inicial
  function resetarTudo() {
    votou = false;
    votoAtual = null;
    codigoSalaAtual = null;
    nomeAtual = null;
    participantesNaSala = [];
    mostrarTela(telaInicial);
    msgCriarSala.classList.add("hidden");
    msgEntrarSala.classList.add("hidden");
    inputCodigoSala.value = "";
    inputNomeParticipante.value = "";
    inputNomeHost.value = "";
    listaMaterias.innerHTML = "";
    statusVotacao.textContent = "";
    confirmacaoVoto.classList.add("hidden");
    resultadoVotacao.classList.add("hidden");
    if (pollingInterval) clearInterval(pollingInterval);
  }

  // Ao carregar, mostra tela inicial
  mostrarTela(telaInicial);
</script>

</body>
</html>
