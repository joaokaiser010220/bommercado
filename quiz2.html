<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz Sapichões Multiplayer</title>

<!-- Fonte -->
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">

<style>
  /* Reset */
  * {
    box-sizing: border-box;
    margin: 0; padding: 0;
  }

  body {
    font-family: 'Comic Neue', cursive;
    background: linear-gradient(135deg, #a8e6cf, #dcedc1);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 30px;
    color: #2e7d32;
  }

  #app {
    background: white;
    max-width: 900px;
    width: 100%;
    border-radius: 30px;
    box-shadow: 0 22px 60px rgba(46,125,50,0.45);
    padding: 40px 50px;
    position: relative;
  }

  h1, h2, h3, h4 {
    font-family: 'Fredoka One', cursive;
    margin-bottom: 20px;
    color: #2e7d32;
  }

  input, select, button {
    font-family: 'Comic Neue', cursive;
    font-weight: bold;
  }

  input[type="text"], input[type="password"], input[type="number"], select {
    width: 100%;
    padding: 14px 20px;
    font-size: 1.2rem;
    border: 3px solid #a5d6a7;
    border-radius: 25px;
    margin-bottom: 20px;
    outline: none;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    text-transform: none;
    color: #2e7d32;
    background-color: #f9fff6;
  }

  input[type="text"]:focus, input[type="password"]:focus, select:focus {
    border-color: #2e7d32;
    box-shadow: 0 0 12px #81c784bb;
  }

  button {
    background: #cdeccd;
    color: #000000;
    font-weight: bold;
    font-size: 1.3rem;
    padding: 16px;
    border: 3px solid #4caf50;
    border-radius: 30px;
    cursor: pointer;
    box-shadow: 0 10px 30px #2e7d3280;
    transition: background 0.3s ease, color 0.3s ease;
    margin-top: 5px;
    user-select: none;
  }

  button:hover:not(:disabled) {
    background: #4caf50;
    color: white;
  }

  button:disabled {
    background: #a5d6a7;
    cursor: not-allowed;
    box-shadow: none;
    color: #555;
  }

  .hidden {
    display: none;
  }

  ul {
    list-style: none;
    margin-bottom: 20px;
    padding-left: 0;
  }

  ul li {
    background: #dcedc1;
    margin: 5px 0;
    padding: 10px 15px;
    border-radius: 20px;
    font-weight: bold;
    color: #2e7d32;
  }

  .materia-btn {
    padding: 12px 22px;
    margin: 5px 8px 5px 0;
    border: 3px solid #4caf50;
    border-radius: 25px;
    background: #f9fff6;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-block;
    user-select: none;
    color: #000;
  }

  .materia-btn.selected {
    background-color: #4caf50;
    color: white;
    border-color: #2e7d32;
  }

  /* Chat fixo no canto inferior direito */
  #chat-button {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: #4caf50;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    box-shadow: 0 10px 30px #2e7d3280;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: background 0.3s ease;
    border: none;
  }

  #chat-button:hover {
    background: #2e7d32;
  }

  #chat-button svg {
    fill: white;
    width: 30px;
    height: 30px;
  }

  /* Loading */
  #loading {
    position: fixed;
    top: 0; left: 0; right:0; bottom:0;
    background: rgba(255,255,255,0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: 'Fredoka One', cursive;
    font-size: 2rem;
    color: #2e7d32;
    z-index: 9999;
    display: none;
  }

  /* Perguntas */
  #pergunta-container {
    margin-bottom: 20px;
  }

  .opcao {
    background: #dcedc1;
    margin: 10px 0;
    padding: 15px 20px;
    border-radius: 25px;
    font-weight: bold;
    cursor: pointer;
    user-select: none;
    border: 3px solid transparent;
    transition: border-color 0.3s ease, color 0.3s ease, background-color 0.3s ease;
    color: #000;
  }

  .opcao:hover {
    border-color: #81c784;
  }

  .opcao.selected {
    border-color: #4caf50;
    background-color: #a5d6a7;
    color: #2e7d32;
  }

  @media (max-width: 768px) {
    #app {
      padding: 25px 20px;
    }
    button, input[type="text"], select {
      font-size: 1.1rem;
    }
  }
</style>

</head>
<body>

<div id="app">

  <!-- Login -->
  <div id="login-screen">
    <h1>Bem-vindo ao Quiz Sapichões!</h1>
    <input type="text" id="input-nome" placeholder="Seu nome" autocomplete="off" />
    <button id="btn-login">Entrar</button>
  </div>

  <!-- Menu -->
  <div id="menu-screen" class="hidden">
    <h2>Olá, <span id="nome-usuario"></span></h2>
    <button id="btn-criar-sala">Criar Sala</button>

    <div style="margin: 20px 0; font-weight: bold;">Ou entre numa sala</div>
    <input type="text" id="input-codigo-sala" maxlength="6" placeholder="Código da sala (6 caracteres)" style="text-transform:uppercase" autocomplete="off" />
    <button id="btn-entrar-sala">Entrar na Sala</button>
  </div>

  <!-- Sala -->
  <div id="sala-screen" class="hidden">
    <h2>Sala: <span id="codigo-sala"></span></h2>
    <p><strong>Status:</strong> <span id="status-sala"></span></p>
    <p><strong>Host:</strong> <span id="host-sala"></span></p>
    <p><strong>Participantes:</strong></p>
    <ul id="lista-participantes"></ul>

    <div id="host-actions" class="hidden" style="margin-bottom:20px;">
      <button id="btn-iniciar-votacao">Iniciar Votação</button>
    </div>

    <div id="votacao-screen" class="hidden">
      <h3>Vote na matéria para o quiz</h3>
      <div id="materias-lista"></div>
      <p>Tempo para votar: <span id="timer-votacao">300</span> segundos</p>
      <button id="btn-enviar-voto" disabled>Enviar Voto</button>
    </div>

    <div id="quiz-screen" class="hidden">
      <h3>Quiz: <span id="materia-quiz"></span></h3>
      <div id="pergunta-container"></div>
      <button id="btn-proxima-pergunta" disabled>Próxima</button>
    </div>

    <div id="resultado-screen" class="hidden">
      <h3>Resultados</h3>
      <p>Você acertou <span id="acertos"></span> de <span id="total-perguntas"></span> perguntas.</p>
      <button id="btn-voltar-menu">Voltar ao menu</button>
    </div>

    <div id="ranking-screen" class="hidden">
      <h3>Ranking da sala</h3>
      <ol id="ranking-lista"></ol>
    </div>
  </div>

</div>

<!-- Botão de chat -->
<button id="chat-button" title="Abrir chat">
  <!-- Ícone de chat -->
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 2H4C2.9 2 2 2.9 2 4v16l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
</button>

<div id="loading">Carregando...</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
 
// Configuração Firebase - só o link do database
const firebaseConfig = {
  databaseURL: "https://sapichoes1-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Variáveis principais
let usuario = null;
let codigoSala = null;
let salaData = null;
let materiaVencedora = null;
let votoSelecionado = null;
let perguntas = null;
let perguntaIndex = 0;
let respostasUsuario = [];

// Tempo votação (em segundos)
const TEMPO_VOTACAO = 60; // 1 minuto para votar por participante

// Timer por usuário
let timerInterval = null;
let tempoRestante = TEMPO_VOTACAO;

// Matérias fixas
const materiasFixas = ["História", "Português", "Geografia", "Artes", "Matemática", "Inglês"];

// Perguntas exemplo (adicione perguntas reais aqui)
const perguntasJSON = {
  "Matemática": [
    { pergunta: "Quanto é 12 x 4?", opcoes: ["48", "42", "52", "44"], resposta: 0 },
    { pergunta: "Qual é o valor de x na equação: 3x + 5 = 14?", opcoes: ["3", "4", "5", "6"], resposta: 0 },
    { pergunta: "Qual é o número primo?", opcoes: ["15", "21", "17", "27"], resposta: 2 },
    { pergunta: "Qual a fração equivalente a 1/2?", opcoes: ["2/4", "3/5", "4/6", "5/10"], resposta: 0 },
    { pergunta: "Quanto é 100 dividido por 4?", opcoes: ["25", "24", "20", "30"], resposta: 0 },
    { pergunta: "Qual é o resultado de 7²?", opcoes: ["49", "14", "42", "77"], resposta: 0 },
    { pergunta: "Quantos lados tem um hexágono?", opcoes: ["5", "6", "7", "8"], resposta: 1 },
    { pergunta: "Qual é a raiz quadrada de 81?", opcoes: ["7", "8", "9", "10"], resposta: 2 },
    { pergunta: "Quanto é 15% de 200?", opcoes: ["20", "25", "30", "35"], resposta: 2 },
    { pergunta: "Qual é o perímetro de um quadrado de lado 5?", opcoes: ["10", "15", "20", "25"], resposta: 2 }
  ],

  "História": [
    { pergunta: "Quem foi o primeiro presidente do Brasil?", opcoes: ["Getúlio Vargas", "Deodoro da Fonseca", "Juscelino Kubitschek", "Pedro II"], resposta: 1 },
    { pergunta: "Em que ano ocorreu a Proclamação da República no Brasil?", opcoes: ["1889", "1822", "1500", "1930"], resposta: 0 },
    { pergunta: "Quem foi Dom Pedro I?", opcoes: ["Imperador do Brasil", "Presidente do Brasil", "Rei de Portugal", "General na Guerra"], resposta: 0 },
    { pergunta: "Qual evento marcou a independência do Brasil?", opcoes: ["Dia da Bandeira", "Independência ou Morte", "Dia do Trabalhador", "Festa Junina"], resposta: 1 },
    { pergunta: "Quem foi o líder da Inconfidência Mineira?", opcoes: ["Tiradentes", "Zumbi dos Palmares", "Dom Pedro II", "Getúlio Vargas"], resposta: 0 },
    { pergunta: "Qual civilização construiu as pirâmides?", opcoes: ["Maias", "Egípcios", "Romanos", "Gregos"], resposta: 1 },
    { pergunta: "Quando terminou a Segunda Guerra Mundial?", opcoes: ["1945", "1939", "1918", "1950"], resposta: 0 },
    { pergunta: "Quem foi Nelson Mandela?", opcoes: ["Presidente da África do Sul", "Presidente do Brasil", "Presidente dos EUA", "Rei da Inglaterra"], resposta: 0 },
    { pergunta: "O que foi o movimento das Diretas Já?", opcoes: ["Luta pela democracia no Brasil", "Guerra mundial", "Revolução Francesa", "Movimento cultural"], resposta: 0 },
    { pergunta: "Qual era o principal produto do ciclo do ouro no Brasil?", opcoes: ["Ouro", "Prata", "Café", "Tabaco"], resposta: 0 }
  ],

  "Português": [
    { pergunta: "Qual dessas palavras é um verbo?", opcoes: ["Casa", "Correr", "Bonito", "Feliz"], resposta: 1 },
    { pergunta: "Qual é o plural de 'lápis'?", opcoes: ["Lápises", "Lápis", "Lápiseses", "Lapises"], resposta: 1 },
    { pergunta: "Qual é a classe da palavra 'rápido'?", opcoes: ["Substantivo", "Adjetivo", "Verbo", "Advérbio"], resposta: 1 },
    { pergunta: "Qual é o sujeito da frase: 'O gato dorme no sofá'?", opcoes: ["O gato", "Dorme", "No sofá", "A frase não tem sujeito"], resposta: 0 },
    { pergunta: "Qual dessas palavras é um advérbio?", opcoes: ["Lentamente", "Feliz", "Casa", "Correr"], resposta: 0 },
    { pergunta: "Qual é o antônimo de 'alto'?", opcoes: ["Baixo", "Grande", "Forte", "Rápido"], resposta: 0 },
    { pergunta: "Qual é a forma correta do plural de 'pão'?", opcoes: ["Pães", "Pãos", "Pãeses", "Pãoses"], resposta: 0 },
    { pergunta: "Qual dessas frases está correta?", opcoes: ["Eu vou no mercado", "Eu vou ao mercado", "Eu vou na mercado", "Eu vou em mercado"], resposta: 1 },
    { pergunta: "O que é um substantivo?", opcoes: ["Nome de coisa, pessoa ou lugar", "Ação", "Qualidade", "Lugar"], resposta: 0 },
    { pergunta: "Qual é o tempo verbal da frase: 'Ela estava cantando'?", opcoes: ["Presente", "Pretérito Imperfeito", "Futuro", "Pretérito Perfeito"], resposta: 1 }
  ],

  "Geografia": [
    { pergunta: "Qual é o maior país do mundo em área territorial?", opcoes: ["Brasil", "China", "Rússia", "Estados Unidos"], resposta: 2 },
    { pergunta: "Qual é o continente onde fica o Brasil?", opcoes: ["América do Sul", "América do Norte", "África", "Europa"], resposta: 0 },
    { pergunta: "Qual é o maior oceano do planeta?", opcoes: ["Atlântico", "Índico", "Pacífico", "Ártico"], resposta: 2 },
    { pergunta: "Qual é a capital do Brasil?", opcoes: ["Rio de Janeiro", "Brasília", "São Paulo", "Salvador"], resposta: 1 },
    { pergunta: "Qual é o principal rio da América do Sul?", opcoes: ["Rio Amazonas", "Rio São Francisco", "Rio Paraná", "Rio Doce"], resposta: 0 },
    { pergunta: "Qual dessas é uma característica do clima tropical?", opcoes: ["Frio intenso", "Chuvas no verão", "Nevadas", "Secas no inverno"], resposta: 1 },
    { pergunta: "Qual é a maior floresta tropical do mundo?", opcoes: ["Floresta Negra", "Floresta Amazônica", "Floresta de Sherwood", "Floresta do Congo"], resposta: 1 },
    { pergunta: "O que é uma península?", opcoes: ["Porção de terra cercada por água em três lados", "Ilha", "Deserto", "Montanha"], resposta: 0 },
    { pergunta: "Qual é a principal atividade econômica do Brasil?", opcoes: ["Agricultura", "Indústria automobilística", "Petróleo", "Tecnologia"], resposta: 0 },
    { pergunta: "Qual é o movimento das placas tectônicas que causa terremotos?", opcoes: ["Erosão", "Subducção", "Placas deslizantes", "Deposição"], resposta: 2 }
  ],

  "Ciências": [
    { pergunta: "Qual é o órgão responsável pela respiração humana?", opcoes: ["Coração", "Pulmão", "Fígado", "Rim"], resposta: 1 },
    { pergunta: "Qual destes animais é um mamífero?", opcoes: ["Cobra", "Golfinho", "Jacaré", "Pomba"], resposta: 1 },
    { pergunta: "Qual é a fonte principal de energia para a Terra?", opcoes: ["Luz da Lua", "Vento", "Sol", "Água"], resposta: 2 },
    { pergunta: "Qual é o processo pelo qual as plantas produzem seu alimento?", opcoes: ["Respiração", "Fotossíntese", "Digestão", "Fermentação"], resposta: 1 },
    { pergunta: "Qual substância dá cor verde às plantas?", opcoes: ["Clorofila", "Melanina", "Hemoglobina", "Caroteno"], resposta: 0 },
    { pergunta: "O que os seres humanos precisam para viver?", opcoes: ["Água, ar, comida", "Água, ouro, fogo", "Fogo, terra, vento", "Comida, dinheiro, luz"], resposta: 0 },
    { pergunta: "Qual é o maior órgão do corpo humano?", opcoes: ["Fígado", "Cérebro", "Pele", "Coração"], resposta: 2 },
    { pergunta: "Qual é o líquido que transporta oxigênio no sangue?", opcoes: ["Plasma", "Hemoglobina", "Sangue", "Líquido cefalorraquidiano"], resposta: 1 },
    { pergunta: "Qual destes animais é invertebrado?", opcoes: ["Cachorro", "Peixe", "Polvo", "Gato"], resposta: 2 },
    { pergunta: "Qual é o estado da água em temperatura ambiente?", opcoes: ["Sólido", "Líquido", "Gasoso", "Plasma"], resposta: 1 }
  ],

  "Inglês": [
    { pergunta: "How do you say 'casa' in English?", opcoes: ["Car", "House", "Dog", "Tree"], resposta: 1 },
    { pergunta: "What color is the sky on a clear day?", opcoes: ["Blue", "Green", "Red", "Yellow"], resposta: 0 },
    { pergunta: "Which word is a fruit?", opcoes: ["Apple", "Car", "Dog", "Table"], resposta: 0 },
    { pergunta: "What does 'run' mean?", opcoes: ["Correr", "Pular", "Comer", "Dormir"], resposta: 0 },
    { pergunta: "How do you say 'amigo' in English?", opcoes: ["Friend", "Enemy", "Teacher", "Student"], resposta: 0 },
    { pergunta: "What is the opposite of 'big'?", opcoes: ["Small", "Tall", "Fast", "Slow"], resposta: 0 },
    { pergunta: "Which one is a color?", opcoes: ["Dog", "Red", "Car", "Table"], resposta: 1 },
    { pergunta: "How do you say 'livro' in English?", opcoes: ["Book", "Pen", "Table", "Chair"], resposta: 0 },
    { pergunta: "What does 'eat' mean?", opcoes: ["Comer", "Beber", "Correr", "Brincar"], resposta: 0 },
    { pergunta: "Which animal barks?", opcoes: ["Cat", "Dog", "Bird", "Fish"], resposta: 1 }
  ]
};

// --- ELEMENTOS DOM ---
const inputNome = document.getElementById('input-nome');
const btnLogin = document.getElementById('btn-login');
const loginScreen = document.getElementById('login-screen');
const menuScreen = document.getElementById('menu-screen');
const nomeUsuarioSpan = document.getElementById('nome-usuario');

const btnCriarSala = document.getElementById('btn-criar-sala');
const inputCodigoSala = document.getElementById('input-codigo-sala');
const btnEntrarSala = document.getElementById('btn-entrar-sala');

const salaScreen = document.getElementById('sala-screen');
const codigoSalaSpan = document.getElementById('codigo-sala');
const statusSalaSpan = document.getElementById('status-sala');
const hostSalaSpan = document.getElementById('host-sala');
const listaParticipantesUl = document.getElementById('lista-participantes');
const hostActionsDiv = document.getElementById('host-actions');
const btnIniciarVotacao = document.getElementById('btn-iniciar-votacao');

const votacaoScreen = document.getElementById('votacao-screen');
const materiasListaDiv = document.getElementById('materias-lista');
const timerVotacaoSpan = document.getElementById('timer-votacao');
const btnEnviarVoto = document.getElementById('btn-enviar-voto');

const quizScreen = document.getElementById('quiz-screen');
const materiaQuizSpan = document.getElementById('materia-quiz');
const perguntaContainerDiv = document.getElementById('pergunta-container');
const btnProximaPergunta = document.getElementById('btn-proxima-pergunta');

const resultadoScreen = document.getElementById('resultado-screen');
const acertosSpan = document.getElementById('acertos');
const totalPerguntasSpan = document.getElementById('total-perguntas');
const btnVoltarMenu = document.getElementById('btn-voltar-menu');

const rankingScreen = document.getElementById('ranking-screen');
const rankingLista = document.getElementById('ranking-lista');

// Função para gerar código da sala
function gerarCodigoSala() {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let codigo = "";
  for (let i = 0; i < 6; i++) {
    codigo += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return codigo;
}

// Mostrar loading
function mostrarLoading(estado) {
  const loading = document.getElementById('loading');
  if (estado) loading.style.display = 'flex';
  else loading.style.display = 'none';
}

// --- LOGIN ---
btnLogin.onclick = () => {
  const nome = inputNome.value.trim();
  if (!nome) {
    alert("Digite seu nome para continuar");
    return;
  }
  usuario = nome;
  loginScreen.classList.add('hidden');
  menuScreen.classList.remove('hidden');
  nomeUsuarioSpan.textContent = usuario;
};

// --- CRIAR SALA ---
btnCriarSala.onclick = async () => {
  mostrarLoading(true);
  let codigo = gerarCodigoSala();
  while ((await db.ref('salas/' + codigo).get()).exists()) {
    codigo = gerarCodigoSala();
  }

  const novaSala = {
    host: usuario,
    materias: materiasFixas,
    participantes: [usuario],
    status: "aguardando",
    votos: {},       // votos vazios no começo
  };
  await db.ref('salas/' + codigo).set(novaSala);
  mostrarLoading(false);
  alert(`Sala criada com código: ${codigo}`);
  entrarNaSala(codigo);
};

// --- ENTRAR NA SALA ---
btnEntrarSala.onclick = () => {
  const codigo = inputCodigoSala.value.trim().toUpperCase();
  if (codigo.length !== 6) {
    alert("Digite um código válido de 6 caracteres");
    return;
  }
  entrarNaSala(codigo);
};

async function entrarNaSala(codigo) {
  mostrarLoading(true);
  const refSala = db.ref('salas/' + codigo);
  const snapshot = await refSala.get();
  if (!snapshot.exists()) {
    mostrarLoading(false);
    alert("Sala não encontrada");
    return;
  }
  salaData = snapshot.val();

  if (!salaData.participantes) salaData.participantes = [];
  if (!salaData.participantes.includes(usuario)) {
    salaData.participantes.push(usuario);
    await refSala.update({ participantes: salaData.participantes });
  }

  codigoSala = codigo;
  mostrarLoading(false);
  abrirSala();
}

// --- ABRIR SALA ---
function abrirSala() {
  menuScreen.classList.add('hidden');
  salaScreen.classList.remove('hidden');
  atualizarTelaSala();
  escutarSalaFirebase();
}

// Atualiza dados na tela da sala
function atualizarTelaSala() {
  codigoSalaSpan.textContent = codigoSala;
  statusSalaSpan.textContent = salaData.status;
  hostSalaSpan.textContent = salaData.host;
  listaParticipantesUl.innerHTML = '';
  salaData.participantes.forEach(p => {
    const li = document.createElement('li');
    li.textContent = p;
    // mostra quem já votou
    if (salaData.votos && salaData.votos[p] !== undefined) {
      li.textContent += " (votou)";
    }
    listaParticipantesUl.appendChild(li);
  });

  if (usuario === salaData.host && salaData.status === "aguardando") {
    hostActionsDiv.classList.remove('hidden');
  } else {
    hostActionsDiv.classList.add('hidden');
  }

  votacaoScreen.classList.add('hidden');
  quizScreen.classList.add('hidden');
  resultadoScreen.classList.add('hidden');
  rankingScreen.classList.add('hidden');
}

// Escuta mudanças na sala no Firebase (pra sincronizar em tempo real)
function escutarSalaFirebase() {
  db.ref('salas/' + codigoSala).on('value', (snapshot) => {
    if (!snapshot.exists()) return;
    salaData = snapshot.val();
    atualizarTelaSala();

    if (salaData.status === 'votacao') {
      iniciarTelaVotacao();
    } else if (salaData.status === 'quiz') {
      if (!perguntas) {
        materiaVencedora = salaData.materiaVencedora || salaData.materiaSelecionada;
        perguntas = perguntasJSON[materiaVencedora];
        perguntaIndex = 0;
        respostasUsuario = [];
        iniciarQuiz();
      }
    } else if (salaData.status === 'resultado') {
      mostrarResultado();
    } else if (salaData.status === 'ranking') {
      mostrarRanking();
    }
  });
}

// --- INICIAR VOTAÇÃO (só host pode) ---
btnIniciarVotacao.onclick = async () => {
  if (usuario !== salaData.host) return;
  if (salaData.status !== "aguardando") return;

  // Zera votos e muda status da sala para votacao
  await db.ref('salas/' + codigoSala).update({ status: "votacao", votos: {} });

  tempoRestante = TEMPO_VOTACAO;
  iniciarTimerVotacao();
};

// --- TELA DE VOTAÇÃO ---
function iniciarTelaVotacao() {
  votacaoScreen.classList.remove('hidden');
  quizScreen.classList.add('hidden');
  resultadoScreen.classList.add('hidden');
  rankingScreen.classList.add('hidden');
  hostActionsDiv.classList.add('hidden');

  materiasListaDiv.innerHTML = '';
  votoSelecionado = null;
  btnEnviarVoto.disabled = true;

  const jaVotou = salaData.votos && salaData.votos[usuario] !== undefined;

  salaData.materias.forEach(materia => {
    const btn = document.createElement('button');
    btn.textContent = materia;
    btn.className = 'materia-btn';

    if (jaVotou) {
      btn.disabled = true;
      if (salaData.votos[usuario] === materia) {
        btn.classList.add('selected');
      }
    } else {
      btn.onclick = () => {
        Array.from(materiasListaDiv.children).forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        votoSelecionado = materia;
        btnEnviarVoto.disabled = false;
      };
    }

    materiasListaDiv.appendChild(btn);
  });

  timerVotacaoSpan.textContent = tempoRestante;
}

// --- CONTADOR DE TEMPO DA VOTAÇÃO POR USUÁRIO ---
function iniciarTimerVotacao() {
  if (timerInterval) clearInterval(timerInterval);

  timerInterval = setInterval(async () => {
    tempoRestante--;
    timerVotacaoSpan.textContent = tempoRestante;

    if (tempoRestante <= 0) {
      clearInterval(timerInterval);
      if (!(salaData.votos && salaData.votos[usuario] !== undefined)) {
        // Salva voto null se o usuário não votou
        await enviarVoto(null);
      }
      // Verifica se todos votaram para avançar
      await checarTodosVotaram();
    }
  }, 1000);
}

// --- ENVIAR VOTO ---
btnEnviarVoto.onclick = async () => {
  if (!votoSelecionado) return;
  if (salaData.votos && salaData.votos[usuario] !== undefined) {
    alert("Você já votou!");
    return;
  }
  await enviarVoto(votoSelecionado);
};

async function enviarVoto(voto) {
  await db.ref(`salas/${codigoSala}/votos/${usuario}`).set(voto);
  btnEnviarVoto.disabled = true;
  alert("Voto enviado! Aguarde os outros participantes.");

  clearInterval(timerInterval);

  // Atualiza a interface localmente para refletir o voto
  salaData.votos[usuario] = voto;
  atualizarTelaSala();

  await checarTodosVotaram();
}

// --- VERIFICA SE TODOS VOTARAM ---
async function checarTodosVotaram() {
  const votosSnapshot = await db.ref(`salas/${codigoSala}/votos`).get();
  const votos = votosSnapshot.exists() ? votosSnapshot.val() : {};

  // Verifica se todos os participantes votaram (voto não é undefined)
  const todosVotaram = salaData.participantes.every(p => votos[p] !== undefined);

  if (todosVotaram) {
    clearInterval(timerInterval);
    await contarVotos();
  }
}

// --- CONTAR VOTOS ---
async function contarVotos() {
  const votosSnapshot = await db.ref(`salas/${codigoSala}/votos`).get();
  const votos = votosSnapshot.exists() ? votosSnapshot.val() : {};

  const contagem = {};
  Object.values(votos).forEach(voto => {
    if (voto !== null) { // ignora votos nulos (sem voto)
      contagem[voto] = (contagem[voto] || 0) + 1;
    }
  });

  let maxVotos = 0;
  let vencedora = null;
  for (const [materia, qtde] of Object.entries(contagem)) {
    if (qtde > maxVotos) {
      maxVotos = qtde;
      vencedora = materia;
    }
  }
  if (!vencedora) vencedora = salaData.materias[0];

  materiaVencedora = vencedora;

  await db.ref('salas/' + codigoSala).update({ status: "quiz", materiaVencedora: vencedora });

  alert(`Votação encerrada! Matéria escolhida: ${vencedora}`);

  perguntas = perguntasJSON[materiaVencedora];
  perguntaIndex = 0;
  respostasUsuario = [];

  mostrarTelaQuiz();
}

// --- QUIZ ---
function iniciarQuiz() {
  materiaQuizSpan.textContent = materiaVencedora;
  mostrarTelaQuiz();
  mostrarPergunta();
}

function mostrarTelaQuiz() {
  votacaoScreen.classList.add('hidden');
  quizScreen.classList.remove('hidden');
  resultadoScreen.classList.add('hidden');
  rankingScreen.classList.add('hidden');
}

function mostrarPergunta() {
  perguntaContainerDiv.innerHTML = '';

  if (!perguntas || perguntaIndex >= perguntas.length) {
    finalizarQuiz();
    return;
  }

  const p = perguntas[perguntaIndex];

  const perguntaTitulo = document.createElement('h4');
  perguntaTitulo.textContent = `Pergunta ${perguntaIndex + 1}: ${p.pergunta}`;
  perguntaContainerDiv.appendChild(perguntaTitulo);

  p.opcoes.forEach((opcaoTexto, idx) => {
    const btnOpcao = document.createElement('button');
    btnOpcao.textContent = opcaoTexto;
    btnOpcao.className = 'opcao';
    btnOpcao.onclick = () => {
      Array.from(perguntaContainerDiv.querySelectorAll('.opcao')).forEach(b => b.classList.remove('selected'));
      btnOpcao.classList.add('selected');
      btnProximaPergunta.disabled = false;
      respostasUsuario[perguntaIndex] = idx;
    };
    perguntaContainerDiv.appendChild(btnOpcao);
  });

  btnProximaPergunta.disabled = true;
}

btnProximaPergunta.onclick = () => {
  perguntaIndex++;
  mostrarPergunta();
};

function finalizarQuiz() {
  let acertos = 0;
  for(let i=0; i<perguntas.length; i++) {
    if(respostasUsuario[i] === perguntas[i].resposta) acertos++;
  }

  acertosSpan.textContent = acertos;
  totalPerguntasSpan.textContent = perguntas.length;

  db.ref('salas/' + codigoSala).update({ status: "resultado" });

  mostrarTelaResultado();
}

function mostrarResultado() {
  votacaoScreen.classList.add('hidden');
  quizScreen.classList.add('hidden');
  resultadoScreen.classList.remove('hidden');
  rankingScreen.classList.add('hidden');
}

btnVoltarMenu.onclick = () => {
  location.reload();
};

function finalizarQuiz() {
  let acertos = 0;
  for (let i = 0; i < perguntas.length; i++) {
    if (respostasUsuario[i] === perguntas[i].resposta) acertos++;
  }

  acertosSpan.textContent = acertos;
  totalPerguntasSpan.textContent = perguntas.length;

  // Salva o resultado do jogador no Firebase
  db.ref(`salas/${codigoSala}/resultados/${usuario}`).set(acertos);

  // Se todos responderam, muda status para ranking
  verificarTodosTerminaramQuiz();

  mostrarTelaResultado();
}

async function verificarTodosTerminaramQuiz() {
  const resultadosSnap = await db.ref(`salas/${codigoSala}/resultados`).get();
  const resultados = resultadosSnap.exists() ? resultadosSnap.val() : {};

  if (Object.keys(resultados).length === salaData.participantes.length) {
    // Todos terminaram
    await db.ref('salas/' + codigoSala).update({ status: "ranking" });
  }
}

// --- RANKING ---
function mostrarRanking() {
  votacaoScreen.classList.add('hidden');
  quizScreen.classList.add('hidden');
  resultadoScreen.classList.add('hidden');
  rankingScreen.classList.remove('hidden');
  rankingLista.innerHTML = '';

  const resultados = salaData.resultados || {};

  // Ordena do maior para o menor
  const rankingOrdenado = Object.entries(resultados)
    .sort((a, b) => b[1] - a[1]); // b[1] e a[1] são os acertos

  rankingOrdenado.forEach(([nome, pontos], index) => {
    const li = document.createElement('li');
    li.innerHTML = `<strong>${index + 1}º</strong> ${nome} - ${pontos} acertos`;
    if (index === 0) {
      li.style.color = 'gold';
      li.style.fontWeight = 'bold';
    }
    rankingLista.appendChild(li);
  });
}



</script>

</body>
</html>
