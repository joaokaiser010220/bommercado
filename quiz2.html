<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz Sapichões Multiplayer</title>

<!-- Fonte -->
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">

<style>
  /* Reset */
  * {
    box-sizing: border-box;
    margin: 0; padding: 0;
  }

  body {
    font-family: 'Comic Neue', cursive;
    background: linear-gradient(135deg, #a8e6cf, #dcedc1);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 30px;
    color: #2e7d32;
  }

  #app {
    background: white;
    max-width: 900px;
    width: 100%;
    border-radius: 30px;
    box-shadow: 0 22px 60px rgba(46,125,50,0.45);
    padding: 40px 50px;
    position: relative;
  }

  h1, h2, h3 {
    font-family: 'Fredoka One', cursive;
    margin-bottom: 20px;
  }

  input, select, button {
    font-family: 'Comic Neue', cursive;
  }

  input[type="text"], input[type="password"], input[type="number"], select {
    width: 100%;
    padding: 14px 20px;
    font-size: 1.2rem;
    border: 3px solid #a5d6a7;
    border-radius: 25px;
    margin-bottom: 20px;
    outline: none;
    font-weight: bold;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    text-transform: none;
  }

  input[type="text"]:focus, input[type="password"]:focus, select:focus {
    border-color: #2e7d32;
    box-shadow: 0 0 12px #81c784bb;
  }

  button {
    background: #4caf50;
    color: white;
    font-weight: bold;
    font-size: 1.3rem;
    padding: 16px;
    border: none;
    border-radius: 30px;
    cursor: pointer;
    box-shadow: 0 10px 30px #2e7d3280;
    transition: background 0.3s ease;
    margin-top: 5px;
  }

  button:hover:not(:disabled) {
    background: #2e7d32;
  }

  button:disabled {
    background: #a5d6a7;
    cursor: not-allowed;
    box-shadow: none;
  }

  .hidden {
    display: none;
  }

  ul {
    list-style: none;
    margin-bottom: 20px;
  }

  ul li {
    background: #dcedc1;
    margin: 5px 0;
    padding: 10px 15px;
    border-radius: 20px;
    font-weight: bold;
  }

  .materia-btn {
    padding: 12px 22px;
    margin: 5px 8px 5px 0;
    border: 3px solid #4caf50;
    border-radius: 25px;
    background: white;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-block;
    user-select: none;
  }

  .materia-btn.selected {
    background-color: #4caf50;
    color: white;
    border-color: #2e7d32;
  }

  /* Chat fixo no canto inferior direito */
  #chat-button {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: #4caf50;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    box-shadow: 0 10px 30px #2e7d3280;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: background 0.3s ease;
    border: none;
  }

  #chat-button:hover {
    background: #2e7d32;
  }

  #chat-button svg {
    fill: white;
    width: 30px;
    height: 30px;
  }

  /* Loading */
  #loading {
    position: fixed;
    top: 0; left: 0; right:0; bottom:0;
    background: rgba(255,255,255,0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: 'Fredoka One', cursive;
    font-size: 2rem;
    color: #2e7d32;
    z-index: 9999;
    display: none;
  }

  /* Perguntas */
  #pergunta-container {
    margin-bottom: 20px;
  }

  .opcao {
    background: #dcedc1;
    margin: 10px 0;
    padding: 15px 20px;
    border-radius: 25px;
    font-weight: bold;
    cursor: pointer;
    user-select: none;
    border: 3px solid transparent;
    transition: border-color 0.3s ease;
  }

  .opcao:hover {
    border-color: #81c784;
  }

  .opcao.selected {
    border-color: #4caf50;
    background-color: #a5d6a7;
    color: #2e7d32;
  }

  @media (max-width: 768px) {
    #app {
      padding: 25px 20px;
    }
    button, input[type="text"], select {
      font-size: 1.1rem;
    }
  }
</style>

</head>
<body>

<div id="app">

  <!-- Login -->
  <div id="login-screen">
    <h1>Bem-vindo ao Quiz Sapichões!</h1>
    <input type="text" id="input-nome" placeholder="Seu nome" autocomplete="off" />
    <button id="btn-login">Entrar</button>
  </div>

  <!-- Menu -->
  <div id="menu-screen" class="hidden">
    <h2>Olá, <span id="nome-usuario"></span></h2>
    <button id="btn-criar-sala">Criar Sala</button>

    <div style="margin: 20px 0; font-weight: bold;">Ou entre numa sala</div>
    <input type="text" id="input-codigo-sala" maxlength="6" placeholder="Código da sala (6 caracteres)" style="text-transform:uppercase" autocomplete="off" />
    <button id="btn-entrar-sala">Entrar na Sala</button>
  </div>

  <!-- Sala -->
  <div id="sala-screen" class="hidden">
    <h2>Sala: <span id="codigo-sala"></span></h2>
    <p><strong>Status:</strong> <span id="status-sala"></span></p>
    <p><strong>Host:</strong> <span id="host-sala"></span></p>
    <p><strong>Participantes:</strong></p>
    <ul id="lista-participantes"></ul>

    <div id="host-actions" class="hidden" style="margin-bottom:20px;">
      <button id="btn-iniciar-votacao">Iniciar Votação</button>
    </div>

    <div id="votacao-screen" class="hidden">
      <h3>Vote na matéria para o quiz</h3>
      <div id="materias-lista"></div>
      <p>Tempo para votar: <span id="timer-votacao">300</span> segundos</p>
      <button id="btn-enviar-voto" disabled>Enviar Voto</button>
    </div>

    <div id="quiz-screen" class="hidden">
      <h3>Quiz: <span id="materia-quiz"></span></h3>
      <div id="pergunta-container"></div>
      <button id="btn-proxima-pergunta" disabled>Próxima</button>
    </div>

    <div id="resultado-screen" class="hidden">
      <h3>Resultados</h3>
      <p>Você acertou <span id="acertos"></span> de <span id="total-perguntas"></span> perguntas.</p>
      <button id="btn-voltar-menu">Voltar ao menu</button>
    </div>

    <div id="ranking-screen" class="hidden">
      <h3>Ranking da sala</h3>
      <ol id="ranking-lista"></ol>
    </div>
  </div>

</div>

<!-- Botão de chat -->
<button id="chat-button" title="Abrir chat">
  <!-- Ícone de chat -->
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 2H4C2.9 2 2 2.9 2 4v16l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
</button>

<div id="loading">Carregando...</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  // Configuração Firebase - só o link do database
  const firebaseConfig = {
    databaseURL: "https://sapichoes1-default-rtdb.firebaseio.com/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Variáveis principais
  let usuario = null;
  let codigoSala = null;
  let salaData = null;
  let materiaVencedora = null;
  let votoSelecionado = null;
  let perguntas = null;
  let perguntaIndex = 0;
  let respostasUsuario = [];

  // Tempo votação e quiz (em segundos)
  const TEMPO_VOTACAO = 300; // 5 minutos
  let timerVotacaoInterval = null;
  let tempoRestanteVotacao = TEMPO_VOTACAO;

  // Matérias fixas
  const materiasFixas = ["História", "Português", "Geografia", "Artes", "Matemática", "Inglês"];

  // --------- AQUI VOCÊ COLOCA SEU JSON DE PERGUNTAS ---------
  // Exemplo:
  // perguntasJSON = {
  //   "Matemática": [ { pergunta: "1+1=?", opcoes:["1","2"], resposta:1 }, ... ],
  //   "História": [...],
  //   ...
  // }
 const perguntasJSON = {
  "Matemática": [
    { pergunta: "Quanto é 12 x 4?", opcoes: ["48", "42", "52", "44"], resposta: 0 },
    { pergunta: "Qual é o valor de x na equação: 3x + 5 = 14?", opcoes: ["3", "4", "5", "6"], resposta: 0 },
    { pergunta: "Qual é o número primo?", opcoes: ["15", "21", "17", "27"], resposta: 2 },
    { pergunta: "Qual a fração equivalente a 1/2?", opcoes: ["2/4", "3/5", "4/6", "5/10"], resposta: 0 },
    { pergunta: "Quanto é 100 dividido por 4?", opcoes: ["25", "24", "20", "30"], resposta: 0 },
    { pergunta: "Qual é o resultado de 7²?", opcoes: ["49", "14", "42", "77"], resposta: 0 },
    { pergunta: "Quantos lados tem um hexágono?", opcoes: ["5", "6", "7", "8"], resposta: 1 },
    { pergunta: "Qual é a raiz quadrada de 81?", opcoes: ["7", "8", "9", "10"], resposta: 2 },
    { pergunta: "Quanto é 15% de 200?", opcoes: ["20", "25", "30", "35"], resposta: 2 },
    { pergunta: "Qual é o perímetro de um quadrado de lado 5?", opcoes: ["10", "15", "20", "25"], resposta: 2 }
  ],

  "História": [
    { pergunta: "Quem foi o primeiro presidente do Brasil?", opcoes: ["Getúlio Vargas", "Deodoro da Fonseca", "Juscelino Kubitschek", "Pedro II"], resposta: 1 },
    { pergunta: "Em que ano ocorreu a Proclamação da República no Brasil?", opcoes: ["1889", "1822", "1500", "1930"], resposta: 0 },
    { pergunta: "Quem foi Dom Pedro I?", opcoes: ["Imperador do Brasil", "Presidente do Brasil", "Rei de Portugal", "General na Guerra"], resposta: 0 },
    { pergunta: "Qual evento marcou a independência do Brasil?", opcoes: ["Dia da Bandeira", "Independência ou Morte", "Dia do Trabalhador", "Festa Junina"], resposta: 1 },
    { pergunta: "Quem foi o líder da Inconfidência Mineira?", opcoes: ["Tiradentes", "Zumbi dos Palmares", "Dom Pedro II", "Getúlio Vargas"], resposta: 0 },
    { pergunta: "Qual civilização construiu as pirâmides?", opcoes: ["Maias", "Egípcios", "Romanos", "Gregos"], resposta: 1 },
    { pergunta: "Quando terminou a Segunda Guerra Mundial?", opcoes: ["1945", "1939", "1918", "1950"], resposta: 0 },
    { pergunta: "Quem foi Nelson Mandela?", opcoes: ["Presidente da África do Sul", "Presidente do Brasil", "Presidente dos EUA", "Rei da Inglaterra"], resposta: 0 },
    { pergunta: "O que foi o movimento das Diretas Já?", opcoes: ["Luta pela democracia no Brasil", "Guerra mundial", "Revolução Francesa", "Movimento cultural"], resposta: 0 },
    { pergunta: "Qual era o principal produto do ciclo do ouro no Brasil?", opcoes: ["Ouro", "Prata", "Café", "Tabaco"], resposta: 0 }
  ],

  "Português": [
    { pergunta: "Qual dessas palavras é um verbo?", opcoes: ["Casa", "Correr", "Bonito", "Feliz"], resposta: 1 },
    { pergunta: "Qual é o plural de 'lápis'?", opcoes: ["Lápises", "Lápis", "Lápiseses", "Lapises"], resposta: 1 },
    { pergunta: "Qual é a classe da palavra 'rápido'?", opcoes: ["Substantivo", "Adjetivo", "Verbo", "Advérbio"], resposta: 1 },
    { pergunta: "Qual é o sujeito da frase: 'O gato dorme no sofá'?", opcoes: ["O gato", "Dorme", "No sofá", "A frase não tem sujeito"], resposta: 0 },
    { pergunta: "Qual dessas palavras é um advérbio?", opcoes: ["Lentamente", "Feliz", "Casa", "Correr"], resposta: 0 },
    { pergunta: "Qual é o antônimo de 'alto'?", opcoes: ["Baixo", "Grande", "Forte", "Rápido"], resposta: 0 },
    { pergunta: "Qual é a forma correta do plural de 'pão'?", opcoes: ["Pães", "Pãos", "Pãeses", "Pãoses"], resposta: 0 },
    { pergunta: "Qual dessas frases está correta?", opcoes: ["Eu vou no mercado", "Eu vou ao mercado", "Eu vou na mercado", "Eu vou em mercado"], resposta: 1 },
    { pergunta: "O que é um substantivo?", opcoes: ["Nome de coisa, pessoa ou lugar", "Ação", "Qualidade", "Lugar"], resposta: 0 },
    { pergunta: "Qual é o tempo verbal da frase: 'Ela estava cantando'?", opcoes: ["Presente", "Pretérito Imperfeito", "Futuro", "Pretérito Perfeito"], resposta: 1 }
  ],

  "Geografia": [
    { pergunta: "Qual é o maior país do mundo em área territorial?", opcoes: ["Brasil", "China", "Rússia", "Estados Unidos"], resposta: 2 },
    { pergunta: "Qual é o continente onde fica o Brasil?", opcoes: ["América do Sul", "América do Norte", "África", "Europa"], resposta: 0 },
    { pergunta: "Qual é o maior oceano do planeta?", opcoes: ["Atlântico", "Índico", "Pacífico", "Ártico"], resposta: 2 },
    { pergunta: "Qual é a capital do Brasil?", opcoes: ["Rio de Janeiro", "Brasília", "São Paulo", "Salvador"], resposta: 1 },
    { pergunta: "Qual é o principal rio da América do Sul?", opcoes: ["Rio Amazonas", "Rio São Francisco", "Rio Paraná", "Rio Doce"], resposta: 0 },
    { pergunta: "Qual dessas é uma característica do clima tropical?", opcoes: ["Frio intenso", "Chuvas no verão", "Nevadas", "Secas no inverno"], resposta: 1 },
    { pergunta: "Qual é a maior floresta tropical do mundo?", opcoes: ["Floresta Negra", "Floresta Amazônica", "Floresta de Sherwood", "Floresta do Congo"], resposta: 1 },
    { pergunta: "O que é uma península?", opcoes: ["Porção de terra cercada por água em três lados", "Ilha", "Deserto", "Montanha"], resposta: 0 },
    { pergunta: "Qual é a principal atividade econômica do Brasil?", opcoes: ["Agricultura", "Indústria automobilística", "Petróleo", "Tecnologia"], resposta: 0 },
    { pergunta: "Qual é o movimento das placas tectônicas que causa terremotos?", opcoes: ["Erosão", "Subducção", "Placas deslizantes", "Deposição"], resposta: 2 }
  ],

  "Ciências": [
    { pergunta: "Qual é o órgão responsável pela respiração humana?", opcoes: ["Coração", "Pulmão", "Fígado", "Rim"], resposta: 1 },
    { pergunta: "Qual destes animais é um mamífero?", opcoes: ["Cobra", "Golfinho", "Jacaré", "Pomba"], resposta: 1 },
    { pergunta: "Qual é a fonte principal de energia para a Terra?", opcoes: ["Luz da Lua", "Vento", "Sol", "Água"], resposta: 2 },
    { pergunta: "Qual é o processo pelo qual as plantas produzem seu alimento?", opcoes: ["Respiração", "Fotossíntese", "Digestão", "Fermentação"], resposta: 1 },
    { pergunta: "Qual substância dá cor verde às plantas?", opcoes: ["Clorofila", "Melanina", "Hemoglobina", "Caroteno"], resposta: 0 },
    { pergunta: "O que os seres humanos precisam para viver?", opcoes: ["Água, ar, comida", "Água, ouro, fogo", "Fogo, terra, vento", "Comida, dinheiro, luz"], resposta: 0 },
    { pergunta: "Qual é o maior órgão do corpo humano?", opcoes: ["Fígado", "Cérebro", "Pele", "Coração"], resposta: 2 },
    { pergunta: "Qual é o líquido que transporta oxigênio no sangue?", opcoes: ["Plasma", "Hemoglobina", "Sangue", "Líquido cefalorraquidiano"], resposta: 1 },
    { pergunta: "Qual destes animais é invertebrado?", opcoes: ["Cachorro", "Peixe", "Polvo", "Gato"], resposta: 2 },
    { pergunta: "Qual é o estado da água em temperatura ambiente?", opcoes: ["Sólido", "Líquido", "Gasoso", "Plasma"], resposta: 1 }
  ],

  "Inglês": [
    { pergunta: "How do you say 'casa' in English?", opcoes: ["Car", "House", "Dog", "Tree"], resposta: 1 },
    { pergunta: "What color is the sky on a clear day?", opcoes: ["Blue", "Green", "Red", "Yellow"], resposta: 0 },
    { pergunta: "Which word is a fruit?", opcoes: ["Apple", "Car", "Dog", "Table"], resposta: 0 },
    { pergunta: "What does 'run' mean?", opcoes: ["Correr", "Pular", "Comer", "Dormir"], resposta: 0 },
    { pergunta: "How do you say 'amigo' in English?", opcoes: ["Friend", "Enemy", "Teacher", "Student"], resposta: 0 },
    { pergunta: "What is the opposite of 'big'?", opcoes: ["Small", "Tall", "Fast", "Slow"], resposta: 0 },
    { pergunta: "Which one is a color?", opcoes: ["Dog", "Red", "Car", "Table"], resposta: 1 },
    { pergunta: "How do you say 'livro' in English?", opcoes: ["Book", "Pen", "Table", "Chair"], resposta: 0 },
    { pergunta: "What does 'eat' mean?", opcoes: ["Comer", "Beber", "Correr", "Brincar"], resposta: 0 },
    { pergunta: "Which animal barks?", opcoes: ["Cat", "Dog", "Bird", "Fish"], resposta: 1 }
  ]
};

// --- CONSTANTES E VARIÁVEIS GLOBAIS ---
const TEMPO_VOTACAO = 30; // tempo para votação em segundos, ajuste se quiser
let usuario = null;
let codigoSala = null;
let salaData = null;
let materiaVencedora = null;
let votoSelecionado = null;
let perguntas = null;
let perguntaIndex = 0;
let respostasUsuario = [];
let tempoRestanteVotacao = TEMPO_VOTACAO;
let timerVotacaoInterval = null;
let jaVotou = false;

// --- FUNÇÕES UTÉIS ---
function gerarCodigoSala() {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let codigo = "";
  for (let i = 0; i < 6; i++) {
    codigo += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return codigo;
}

function mostrarLoading(estado) {
  const loading = document.getElementById('loading');
  if (estado) loading.style.display = 'flex';
  else loading.style.display = 'none';
}

// --- TELA LOGIN ---
const inputNome = document.getElementById('input-nome');
const btnLogin = document.getElementById('btn-login');
const loginScreen = document.getElementById('login-screen');
const menuScreen = document.getElementById('menu-screen');
const nomeUsuarioSpan = document.getElementById('nome-usuario');

btnLogin.onclick = () => {
  const nome = inputNome.value.trim();
  if (!nome) {
    alert("Digite seu nome para continuar");
    return;
  }
  usuario = nome;
  loginScreen.classList.add('hidden');
  menuScreen.classList.remove('hidden');
  nomeUsuarioSpan.textContent = usuario;
};

// --- MENU ---
const btnCriarSala = document.getElementById('btn-criar-sala');
const inputCodigoSala = document.getElementById('input-codigo-sala');
const btnEntrarSala = document.getElementById('btn-entrar-sala');

btnCriarSala.onclick = async () => {
  mostrarLoading(true);
  let codigo = gerarCodigoSala();
  // Verifica se código existe (garantir unicidade)
  let exists = true;
  while(exists) {
    const snapshot = await db.ref('salas/' + codigo).get();
    if (snapshot.exists()) {
      codigo = gerarCodigoSala();
    } else {
      exists = false;
    }
  }

  // Cria sala no Firebase
  const novaSala = {
    host: usuario,
    materias: materiasFixas,
    participantes: [usuario],
    status: "aguardando",
    votos: {},
    jaVotaram: []
  };
  await db.ref('salas/' + codigo).set(novaSala);

  mostrarLoading(false);
  alert(`Sala criada com código: ${codigo}`);
  entrarNaSala(codigo);
};

btnEntrarSala.onclick = () => {
  const codigo = inputCodigoSala.value.trim().toUpperCase();
  if (codigo.length !== 6) {
    alert("Digite um código válido de 6 caracteres");
    return;
  }
  entrarNaSala(codigo);
};

// --- ENTRAR NA SALA ---
async function entrarNaSala(codigo) {
  mostrarLoading(true);
  const refSala = db.ref('salas/' + codigo);
  const snapshot = await refSala.get();
  if (!snapshot.exists()) {
    mostrarLoading(false);
    alert("Sala não encontrada");
    return;
  }
  salaData = snapshot.val();

  // Adiciona usuário na lista de participantes (se ainda não tiver)
  if(!salaData.participantes) salaData.participantes = [];
  if (!salaData.participantes.includes(usuario)) {
    salaData.participantes.push(usuario);
    await refSala.update({ participantes: salaData.participantes });
  }

  codigoSala = codigo;
  mostrarLoading(false);
  abrirSala();
}

// --- ABRIR TELA SALA ---
const salaScreen = document.getElementById('sala-screen');
const codigoSalaSpan = document.getElementById('codigo-sala');
const statusSalaSpan = document.getElementById('status-sala');
const hostSalaSpan = document.getElementById('host-sala');
const listaParticipantesUl = document.getElementById('lista-participantes');
const hostActionsDiv = document.getElementById('host-actions');
const btnIniciarVotacao = document.getElementById('btn-iniciar-votacao');

const votacaoScreen = document.getElementById('votacao-screen');
const materiasListaDiv = document.getElementById('materias-lista');
const timerVotacaoSpan = document.getElementById('timer-votacao');
const btnEnviarVoto = document.getElementById('btn-enviar-voto');

const quizScreen = document.getElementById('quiz-screen');
const materiaQuizSpan = document.getElementById('materia-quiz');
const perguntaContainerDiv = document.getElementById('pergunta-container');
const btnProximaPergunta = document.getElementById('btn-proxima-pergunta');

const resultadoScreen = document.getElementById('resultado-screen');
const acertosSpan = document.getElementById('acertos');
const totalPerguntasSpan = document.getElementById('total-perguntas');
const btnVoltarMenu = document.getElementById('btn-voltar-menu');

const rankingScreen = document.getElementById('ranking-screen');
const rankingLista = document.getElementById('ranking-lista');

function abrirSala() {
  menuScreen.classList.add('hidden');
  salaScreen.classList.remove('hidden');
  atualizarTelaSala();
  escutarSalaFirebase();
}

// Atualiza os dados básicos na tela da sala
function atualizarTelaSala() {
  codigoSalaSpan.textContent = codigoSala;
  statusSalaSpan.textContent = salaData.status;
  hostSalaSpan.textContent = salaData.host;
  listaParticipantesUl.innerHTML = '';
  salaData.participantes.forEach(p => {
    const li = document.createElement('li');
    li.textContent = p;
    listaParticipantesUl.appendChild(li);
  });

  if (usuario === salaData.host && salaData.status === "aguardando") {
    hostActionsDiv.classList.remove('hidden');
  } else {
    hostActionsDiv.classList.add('hidden');
  }

  // Ajusta telas visíveis
  votacaoScreen.classList.add('hidden');
  quizScreen.classList.add('hidden');
  resultadoScreen.classList.add('hidden');
  rankingScreen.classList.add('hidden');
}

// Escuta mudanças na sala no Firebase para atualizar status em tempo real
function escutarSalaFirebase() {
  db.ref('salas/' + codigoSala).off(); // Remove listener anterior para evitar múltiplos
  db.ref('salas/' + codigoSala).on('value', (snapshot) => {
    if (!snapshot.exists()) return;
    salaData = snapshot.val();
    atualizarTelaSala();

    if (salaData.status === 'votacao') {
      mostrarTelaVotacao();
    } else if (salaData.status === 'quiz') {
      if(!materiaVencedora) {
        // Pega a matéria vencedora pela maior quantidade de votos
        const votos = salaData.votos || {};
        let maiorVoto = 0;
        let materiaMaior = null;
        for(const mat of Object.keys(votos)) {
          if(votos[mat] > maiorVoto) {
            maiorVoto = votos[mat];
            materiaMaior = mat;
          }
        }
        materiaVencedora = materiaMaior || materiasFixas[0];
        perguntas = perguntasJSON[materiaVencedora] || [];
        perguntaIndex = 0;
        respostasUsuario = [];
        mostrarTelaQuiz();
        mostrarPergunta();
      } else {
        mostrarTelaQuiz();
      }
    } else if (salaData.status === 'resultado') {
      mostrarTelaResultado();
    } else if (salaData.status === 'finalizado') {
      mostrarTelaRanking();
    } else {
      // Se status for "aguardando"
      materiaVencedora = null;
      votoSelecionado = null;
      perguntas = null;
      perguntaIndex = 0;
      respostasUsuario = [];
      jaVotou = false;
      if(timerVotacaoInterval) {
        clearInterval(timerVotacaoInterval);
        timerVotacaoInterval = null;
      }
      mostrarTelaSalaNormal();
    }
  });
}

// ---------- TELA VOTAÇÃO ----------
function mostrarTelaVotacao() {
  hostActionsDiv.classList.add('hidden');
  votacaoScreen.classList.remove('hidden');
  quizScreen.classList.add('hidden');
  resultadoScreen.classList.add('hidden');
  rankingScreen.classList.add('hidden');

  mostrarMaterias();

  // Se timer já está rodando, não reinicia
  if(timerVotacaoInterval) return;

  tempoRestanteVotacao = TEMPO_VOTACAO;
  timerVotacaoSpan.textContent = tempoRestanteVotacao;
  votoSelecionado = null;
  btnEnviarVoto.disabled = true;
  jaVotou = false;

  // Verifica se o usuário já votou para bloquear o botão
  if (salaData.jaVotaram && salaData.jaVotaram.includes(usuario)) {
    btnEnviarVoto.disabled = true;
    jaVotou = true;
    alert("Você já votou nessa votação.");
  }

  timerVotacaoInterval = setInterval(() => {
    tempoRestanteVotacao--;
    timerVotacaoSpan.textContent = tempoRestanteVotacao;
    if (tempoRestanteVotacao <= 0) {
      clearInterval(timerVotacaoInterval);
      timerVotacaoInterval = null;
      btnEnviarVoto.disabled = true;
      if(!jaVotou) {
        enviarVoto(); // Envia voto automático se não votou
      }
    }
  }, 1000);
}

// Mostra botões das matérias para votar
function mostrarMaterias() {
  materiasListaDiv.innerHTML = '';
  materiasFixas.forEach(mat => {
    const btn = document.createElement('button');
    btn.textContent = mat;
    btn.classList.add('materia-btn');
    if (votoSelecionado === mat) btn.classList.add('selected');
    btn.onclick = () => {
      if(jaVotou) {
        alert("Você já votou e não pode alterar seu voto.");
        return;
      }
      votoSelecionado = mat;
      atualizarBotoesMaterias();
      btnEnviarVoto.disabled = false;
    };
    materiasListaDiv.appendChild(btn);
  });
}

function atualizarBotoesMaterias() {
  const botoes = document.querySelectorAll('.materia-btn');
  botoes.forEach(btn => {
    if (btn.textContent === votoSelecionado) btn.classList.add('selected');
    else btn.classList.remove('selected');
  });
}

// Enviar voto para Firebase
btnEnviarVoto.onclick = enviarVoto;
async function enviarVoto() {
  if (!votoSelecionado) {
    alert("Selecione uma matéria antes de votar.");
    return;
  }
  if (jaVotou) {
    alert("Você já votou e não pode votar novamente.");
    return;
  }

  btnEnviarVoto.disabled = true;
  if(timerVotacaoInterval) {
    clearInterval(timerVotacaoInterval);
    timerVotacaoInterval = null;
  }

  try {
    // Usa uma transação para incrementar o voto com segurança
    await db.ref('salas/' + codigoSala + '/votos/' + votoSelecionado).transaction((currentVotes) => {
      return (currentVotes || 0) + 1;
    });

    // Marca usuário que já votou
    await db.ref('salas/' + codigoSala + '/jaVotaram').transaction((currentList) => {
      if (!currentList) currentList = [];
      if (!currentList.includes(usuario)) {
        currentList.push(usuario);
      }
      return currentList;
    });

    jaVotou = true;
    alert('Voto enviado com sucesso! Aguarde os outros jogadores.');
  } catch (error) {
    alert('Erro ao enviar voto. Tente novamente.');
    btnEnviarVoto.disabled = false;
    console.error(error);
  }
}

// ---------- TELA QUIZ ----------
function mostrarTelaQuiz() {
  votacaoScreen.classList.add('hidden');
  quizScreen.classList.remove('hidden');
  resultadoScreen.classList.add('hidden');
  rankingScreen.classList.add('hidden');
  hostActionsDiv.classList.add('hidden');
  materiaQuizSpan.textContent = materiaVencedora;
}

// Mostrar pergunta atual
function mostrarPergunta() {
  btnProximaPergunta.disabled = true;
  perguntaContainerDiv.innerHTML = '';

  if (perguntaIndex >= perguntas.length) {
    finalizarQuiz();
    return;
  }

  const p = perguntas[perguntaIndex];
  const perguntaEl = document.createElement('h4');
  perguntaEl.textContent = p.pergunta;
  perguntaContainerDiv.appendChild(perguntaEl);

  p.opcoes.forEach((opcao, i) => {
    const div = document.createElement('div');
    div.textContent = opcao;
    div.classList.add('opcao');
    div.onclick = () => {
      // Marca opção selecionada
      respostasUsuario[perguntaIndex] = i;
      document.querySelectorAll('.opcao').forEach(o => o.classList.remove('selected'));
      div.classList.add('selected');
      btnProximaPergunta.disabled = false;
    };
    perguntaContainerDiv.appendChild(div);
  });
}

btnProximaPergunta.onclick = () => {
  perguntaIndex++;
  mostrarPergunta();
};

// Finaliza quiz e salva resultado
async function finalizarQuiz() {
  // Calcula acertos
  let acertos = 0;
  perguntas.forEach((p, i) => {
    if (respostasUsuario[i] === p.resposta) acertos++;
  });

  // Salva resultado no ranking firebase
  const rankingRef = db.ref('salas/' + codigoSala + '/ranking');
  const snapshot = await rankingRef.get();
  let ranking = snapshot.exists() ? snapshot.val() : {};
  ranking[usuario] = acertos;
  await rankingRef.set(ranking);

  // Atualiza status da sala para resultado
  await db.ref('salas/' + codigoSala).update({ status: "resultado" });

  // Mostra resultado localmente
  acertosSpan.textContent = acertos;
  totalPerguntasSpan.textContent = perguntas.length;
}

// ---------- TELA RESULTADO ----------
function mostrarTelaResultado() {
  votacaoScreen.classList.add('hidden');
  quizScreen.classList.add('hidden');
  resultadoScreen.classList.remove('hidden');
  rankingScreen.classList.add('hidden');
  hostActionsDiv.classList.add('hidden');
}

btnVoltarMenu.onclick = () => {
  resetarSala();
  salaScreen.classList.add('hidden');
  menuScreen.classList.remove('hidden');
};

// ---------- TELA RANKING ----------
async function mostrarTelaRanking() {
  votacaoScreen.classList.add('hidden');
  quizScreen.classList.add('hidden');
  resultadoScreen.classList.add('hidden');
  rankingScreen.classList.remove('hidden');
  hostActionsDiv.classList.add('hidden');

  rankingLista.innerHTML = '';
  const rankingRef = db.ref('salas/' + codigoSala + '/ranking');
  const snapshot = await rankingRef.get();
  let ranking = snapshot.exists() ? snapshot.val() : {};

  // Converte objeto para array para ordenar
  const rankingArray = Object.entries(ranking).sort((a,b) => b[1] - a[1]);
  rankingArray.forEach(([nome, pontos]) => {
    const li = document.createElement('li');
    li.textContent = `${nome} - Acertos: ${pontos}`;
    rankingLista.appendChild(li);
  });
}

// Resetar variáveis e estado para voltar ao menu
function resetarSala() {
  // mantém usuário logado
  codigoSala = null;
  salaData = null;
  materiaVencedora = null;
  votoSelecionado = null;
  perguntas = null;
  perguntaIndex = 0;
  respostasUsuario = [];
  tempoRestanteVotacao = TEMPO_VOTACAO;
  jaVotou = false;
  if(timerVotacaoInterval) {
    clearInterval(timerVotacaoInterval);
    timerVotacaoInterval = null;
  }
}

// Host inicia votação
btnIniciarVotacao.onclick = async () => {
  if (usuario !== salaData.host) {
    alert("Apenas o host pode iniciar a votação.");
    return;
  }
  await db.ref('salas/' + codigoSala).update({
    status: 'votacao',
    votos: {},
    jaVotaram: []
  });
};

// Tela sala normal para host quando não está votando
function mostrarTelaSalaNormal() {
  votacaoScreen.classList.add('hidden');
  quizScreen.classList.add('hidden');
  resultadoScreen.classList.add('hidden');
  rankingScreen.classList.add('hidden');
  hostActionsDiv.classList.remove('hidden');
}

// Botão chat (não implementado)
const chatBtn = document.getElementById('chat-button');
chatBtn.onclick = () => {
  alert('Chat ainda não implementado, mas aqui será a área para conversar!');
};

</script>

</body>
</html>
