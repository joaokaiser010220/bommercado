<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pequenos Gênios - Quiz Online</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    /* RESET */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #A8E063 0%, #56AB2F 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 15px;
      color: #264d00;
      user-select: none;
    }
    h1, h2 {
      text-align: center;
      font-weight: 700;
      margin-bottom: 15px;
      font-family: 'Fredoka One', cursive, sans-serif;
      color: #ffffff;
      text-shadow: 1px 1px 3px #2c5f00;
    }
    button {
      cursor: pointer;
      border-radius: 25px;
      border: none;
      padding: 14px 28px;
      font-size: 1.2rem;
      font-weight: 700;
      transition: background-color 0.3s, transform 0.2s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      user-select: none;
      color: #fff;
      background: #4caf50;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    button:hover, button:focus {
      background-color: #388e3c;
      transform: scale(1.05);
      outline: none;
    }
    button:disabled {
      background: #9ccc65;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    input[type="text"], input[type="password"] {
      font-size: 1.1rem;
      padding: 10px 14px;
      width: 100%;
      max-width: 320px;
      margin-bottom: 20px;
      border-radius: 15px;
      border: 2px solid #8bc34a;
      outline-offset: 2px;
      transition: border-color 0.3s;
    }
    input[type="text"]:focus, input[type="password"]:focus {
      border-color: #4caf50;
      outline: none;
    }
    .container {
      background: #dcedc8;
      padding: 25px 35px;
      border-radius: 30px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      width: 100%;
      max-width: 400px;
      text-align: center;
      color: #264d00;
      user-select: none;
    }
    .hidden {
      display: none !important;
    }
    .btn-primary {
      background: #fbc02d;
      color: #264d00;
      box-shadow: 0 4px 10px rgba(251, 192, 45, 0.7);
    }
    .btn-primary:hover, .btn-primary:focus {
      background: #c79a00;
      color: #fff;
      outline: none;
    }
    .flex-col {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .gap-15 {
      gap: 15px;
    }
    .small-text {
      font-size: 0.9rem;
      color: #4a7520;
      margin-top: -15px;
      margin-bottom: 20px;
    }
    .input-group {
      margin-bottom: 25px;
      width: 100%;
      max-width: 320px;
      text-align: left;
    }
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
    }
    .msg-error {
      color: #d32f2f;
      margin-bottom: 15px;
      font-weight: 700;
    }
    .msg-info {
      color: #2e7d32;
      font-weight: 700;
      margin-bottom: 15px;
    }
    ul {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 200px;
      overflow-y: auto;
      background: #c5e1a5;
      border-radius: 20px;
      box-shadow: inset 0 0 8px rgba(0,0,0,0.1);
    }
    ul li {
      padding: 12px 15px;
      border-bottom: 1px solid #9ccc65;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.25s;
      border-radius: 15px;
      user-select: none;
    }
    ul li:hover {
      background-color: #aed581;
      outline: none;
    }
    ul li.selected {
      background-color: #fbc02d;
      color: #264d00;
      font-weight: 800;
      user-select: none;
    }
    .code-box {
      font-family: 'Courier New', Courier, monospace;
      background: #fff59d;
      padding: 15px 20px;
      border-radius: 20px;
      font-size: 1.5rem;
      letter-spacing: 3px;
      font-weight: 700;
      margin-top: 15px;
      user-select: all;
      box-shadow: 0 0 8px #fbc02d;
    }
    .center {
      text-align: center;
    }
    /* Loader anim */
    .loader {
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-top: 5px solid #fbc02d;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      to {transform: rotate(360deg);}
    }
    /* Responsivo */
    @media (max-width: 480px) {
      .container {
        max-width: 95vw;
        padding: 20px;
      }
      button {
        width: 100%;
        font-size: 1.1rem;
      }
      input[type="text"], input[type="password"] {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>

  <!-- TELA LOGIN -->
  <section id="loginSection" class="container flex-col gap-15" tabindex="0" aria-label="Tela de login">
    <h1>Pequenos Gênios</h1>
    <h2>Confirme sua identidade</h2>
    <div class="input-group">
      <label for="loginNome">Nome:</label>
      <input id="loginNome" type="text" placeholder="Digite seu nome" autocomplete="off" />
    </div>
    <div class="input-group">
      <label for="loginSenha">Senha:</label>
      <input id="loginSenha" type="password" placeholder="Digite sua senha" autocomplete="off" />
    </div>
    <button id="btnLogin" aria-label="Entrar no sistema">Entrar</button>
    <div id="msgLogin" role="alert" class="msg-error" aria-live="polite"></div>
  </section>

  <!-- TELA INICIAL -->
  <section id="homeSection" class="container flex-col gap-15 hidden" tabindex="0" aria-label="Tela inicial com opções de quiz">
    <h1>Bem-vindo(a), <span id="nomeUsuarioHome"></span>!</h1>
    <button id="btnCriarQuiz" aria-label="Criar nova sala de quiz">
      <i class="fas fa-plus"></i> Criar Quiz Online
    </button>
    <button id="btnEntrarSala" class="btn-primary" aria-label="Entrar em sala existente">
      <i class="fas fa-door-open"></i> Entrar na Sala
    </button>
    <button id="btnLogout" style="margin-top:20px; background:#d32f2f;">
      <i class="fas fa-sign-out-alt"></i> Sair
    </button>
  </section>

  <!-- TELA CRIAR QUIZ -->
  <section id="criarQuizSection" class="container flex-col gap-15 hidden" tabindex="0" aria-label="Tela para criar nova sala de quiz">
    <h2>Escolha as matérias do quiz</h2>
    <ul id="listaMaterias">
      <li data-materia="Matemática">Matemática</li>
      <li data-materia="Português">Português</li>
      <li data-materia="História">História</li>
      <li data-materia="Geografia">Geografia</li>
      <li data-materia="Ciências">Ciências</li>
      <li data-materia="Inglês">Inglês</li>
      <li data-materia="Artes">Artes</li>
    </ul>
    <button id="btnConfirmarCriar" aria-label="Confirmar criação da sala">Criar Sala</button>
    <button id="btnVoltarHome1" class="btn-primary">Voltar</button>
    <div id="msgCriar" role="alert" class="msg-error" aria-live="polite"></div>
  </section>

  <!-- TELA ENTRAR NA SALA -->
  <section id="entrarSalaSection" class="container flex-col gap-15 hidden" tabindex="0" aria-label="Tela para entrar em sala existente">
    <h2>Digite o código da sala e seu nome</h2>
    <div class="input-group">
      <label for="codigoSalaInput">Código da Sala (6 caracteres):</label>
      <input id="codigoSalaInput" type="text" maxlength="6" placeholder="Ex: AB12CD" autocomplete="off" />
    </div>
    <div class="input-group">
      <label for="nomeParticipanteInput">Seu nome:</label>
      <input id="nomeParticipanteInput" type="text" placeholder="Digite seu nome" autocomplete="off" />
    </div>
    <button id="btnEntrarNaSalaConfirm" aria-label="Entrar na sala">Entrar</button>
    <button id="btnVoltarHome2" class="btn-primary">Voltar</button>
    <div id="msgEntrar" role="alert" class="msg-error" aria-live="polite"></div>
  </section>

  <!-- TELA SALA (HOST E PARTICIPANTE) -->
  <section id="salaSection" class="container flex-col gap-15 hidden" tabindex="0" aria-label="Tela da sala do quiz">
    <h2>Sala: <span id="codigoSalaDisplay"></span></h2>
    <div id="msgSala" class="msg-info center">Aguardando host iniciar a votação...</div>

    <div id="votacaoHostArea" class="hidden flex-col gap-15">
      <h3>Escolha as matérias para votação</h3>
      <ul id="listaMateriasVotacao">
        <li data-materia="Matemática">Matemática</li>
        <li data-materia="Português">Português</li>
        <li data-materia="História">História</li>
        <li data-materia="Geografia">Geografia</li>
        <li data-materia="Ciências">Ciências</li>
        <li data-materia="Inglês">Inglês</li>
        <li data-materia="Artes">Artes</li>
      </ul>
      <button id="btnIniciarVotacao" aria-label="Iniciar votação">Iniciar Votação</button>
    </div>

    <div id="votacaoParticipanteArea" class="hidden flex-col gap-15">
      <h3>Vote na matéria do quiz</h3>
      <ul id="listaVotosParticipante"></ul>
      <div id="msgAguardeHost" class="msg-info center">Aguarde o host finalizar a votação...</div>
    </div>

    <div id="quizIniciadoArea" class="hidden flex-col gap-15 center">
      <h3>Quiz iniciado!</h3>
      <div id="materiasEscolhidasDisplay"></div>
      <div>Implementação do quiz ainda em desenvolvimento...</div>
    </div>

    <button id="btnSairSala" style="background:#d32f2f; margin-top: 15px;">
      <i class="fas fa-sign-out-alt"></i> Sair da Sala
    </button>
  </section>

<script>
  // URLs Firebase
  const firebaseLoginURL = "https://sapichoes-default-rtdb.firebaseio.com/usuarios.json";
  const firebaseSalasURL = "https://sapichoes1-default-rtdb.firebaseio.com/salas";

  // Variáveis globais
  let usuarioLogado = null;
  let codigoSalaAtual = null;
  let isHost = false;
  let salaDados = null;

  // --- FUNÇÕES AUXILIARES ---

  function mostrarSecao(id) {
    // Esconde tudo e mostra só uma seção
    document.querySelectorAll("section").forEach(s => s.classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
    document.getElementById(id).focus();
  }

  function gerarCodigoSala(tamanho = 6) {
    const caracteres = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    let codigo = "";
    for (let i = 0; i < tamanho; i++) {
      codigo += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
    }
    return codigo;
  }

  // --- LOGIN ---

  async function verificarLogin(nome, senha) {
    try {
      const res = await fetch(firebaseLoginURL);
      if (!res.ok) throw new Error("Erro ao acessar login");
      const dados = await res.json();

      for (const id in dados) {
        const user = dados[id];
        if (user.nome.toLowerCase() === nome.toLowerCase() && user.senha === senha) {
          return true; // login válido
        }
      }
      return false; // não achou
    } catch (err) {
      console.error(err);
      return false;
    }
  }

  // --- CRIAR SALA ---

  async function criarSalaNoFirebase(hostNome, materiasEscolhidas) {
    let codigo = gerarCodigoSala();

    // Verifica se código já existe
    let existe = true;
    while (existe) {
      const res = await fetch(`${firebaseSalasURL}/${codigo}.json`);
      const dados = await res.json();
      if (dados === null) {
        existe = false;
      } else {
        codigo = gerarCodigoSala(); // gera outro código
      }
    }

    // Dados da sala
    const dadosSala = {
      host: hostNome,
      materias: materiasEscolhidas,
      status: "aguardando", // status: aguardando, votacao, quiz
      votos: {},           // votos por participante
      participantes: []    // nomes participantes
    };

    const resCreate = await fetch(`${firebaseSalasURL}/${codigo}.json`, {
      method: "PUT",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(dadosSala)
    });

    if (!resCreate.ok) throw new Error("Erro ao criar sala");

    return codigo;
  }

  // --- ENTRAR NA SALA ---

  async function entrarNaSala(codigo, nomeParticipante) {
    const res = await fetch(`${firebaseSalasURL}/${codigo}.json`);
    if (!res.ok) throw new Error("Erro ao acessar sala");
    const sala = await res.json();
    if (!sala) throw new Error("Sala não encontrada");

    // Adiciona participante na sala se não estiver
    if (!sala.participantes.includes(nomeParticipante)) {
      sala.participantes.push(nomeParticipante);
      await fetch(`${firebaseSalasURL}/${codigo}/participantes.json`, {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(sala.participantes)
      });
    }
    return sala;
  }

  // --- ATUALIZAR SALA NO FIREBASE ---

  async function atualizarSala(codigo, dadosAtualizados) {
    const res = await fetch(`${firebaseSalasURL}/${codigo}.json`, {
      method: "PATCH",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(dadosAtualizados)
    });
    if (!res.ok) throw new Error("Erro ao atualizar sala");
  }

  // --- UI E EVENTOS ---

  // Login
  document.getElementById("btnLogin").addEventListener("click", async () => {
    const nome = document.getElementById("loginNome").value.trim();
    const senha = document.getElementById("loginSenha").value.trim();
    const msgLogin = document.getElementById("msgLogin");

    if (!nome || !senha) {
      msgLogin.textContent = "Por favor, preencha nome e senha.";
      return;
    }
    msgLogin.textContent = "Verificando...";
    const valido = await verificarLogin(nome, senha);

    if (valido) {
      usuarioLogado = nome;
      document.getElementById("nomeUsuarioHome").textContent = usuarioLogado;
      msgLogin.textContent = "";
      mostrarSecao("homeSection");
    } else {
      msgLogin.textContent = "Nome ou senha inválidos.";
    }
  });

  // Logout
  document.getElementById("btnLogout").addEventListener("click", () => {
    usuarioLogado = null;
    codigoSalaAtual = null;
    isHost = false;
    salaDados = null;
    document.getElementById("loginNome").value = "";
    document.getElementById("loginSenha").value = "";
    mostrarSecao("loginSection");
  });

  // Abrir criar quiz
  document.getElementById("btnCriarQuiz").addEventListener("click", () => {
    document.getElementById("msgCriar").textContent = "";
    limparSelecaoMaterias();
    mostrarSecao("criarQuizSection");
  });

  // Voltar do criar quiz
  document.getElementById("btnVoltarHome1").addEventListener("click", () => {
    mostrarSecao("homeSection");
  });

  // Selecionar matérias no criar quiz
  const listaMaterias = document.getElementById("listaMaterias");
  listaMaterias.addEventListener("click", (e) => {
    if (e.target.tagName === "LI") {
      e.target.classList.toggle("selected");
    }
  });
  function limparSelecaoMaterias() {
    listaMaterias.querySelectorAll("li.selected").forEach(li => li.classList.remove("selected"));
  }

  // Confirmar criação de sala
  document.getElementById("btnConfirmarCriar").addEventListener("click", async () => {
    const selecionadas = Array.from(listaMaterias.querySelectorAll("li.selected"))
      .map(li => li.dataset.materia);
    const msgCriar = document.getElementById("msgCriar");

    if (selecionadas.length === 0) {
      msgCriar.textContent = "Selecione pelo menos uma matéria.";
      return;
    }
    msgCriar.textContent = "Criando sala...";

    try {
      const codigo = await criarSalaNoFirebase(usuarioLogado, selecionadas);
      codigoSalaAtual = codigo;
      isHost = true;
      msgCriar.textContent = "";
      prepararTelaSala(codigo, true);
      mostrarSecao("salaSection");
    } catch (error) {
      msgCriar.textContent = "Erro ao criar sala. Tente novamente.";
      console.error(error);
    }
  });

  // Abrir entrar na sala
  document.getElementById("btnEntrarSala").addEventListener("click", () => {
    document.getElementById("msgEntrar").textContent = "";
    document.getElementById("codigoSalaInput").value = "";
    document.getElementById("nomeParticipanteInput").value = usuarioLogado || "";
    mostrarSecao("entrarSalaSection");
  });

  // Voltar do entrar na sala
  document.getElementById("btnVoltarHome2").addEventListener("click", () => {
    mostrarSecao("homeSection");
  });

  // Confirmar entrar na sala
  document.getElementById("btnEntrarNaSalaConfirm").addEventListener("click", async () => {
    const codigo = document.getElementById("codigoSalaInput").value.trim().toUpperCase();
    const nome = document.getElementById("nomeParticipanteInput").value.trim();
    const msgEntrar = document.getElementById("msgEntrar");

    if (codigo.length !== 6) {
      msgEntrar.textContent = "Código deve ter 6 caracteres.";
      return;
    }
    if (!nome) {
      msgEntrar.textContent = "Digite seu nome.";
      return;
    }
    msgEntrar.textContent = "Entrando na sala...";
    try {
      const sala = await entrarNaSala(codigo, nome);
      codigoSalaAtual = codigo;
      salaDados = sala;
      isHost = (usuarioLogado === sala.host);
      msgEntrar.textContent = "";
      prepararTelaSala(codigo, isHost);
      mostrarSecao("salaSection");
      iniciarAtualizacaoSala(codigo);
    } catch (err) {
      msgEntrar.textContent = err.message || "Erro ao entrar na sala.";
      console.error(err);
    }
  });

  // Preparar UI da sala de quiz
  function prepararTelaSala(codigo, host) {
    document.getElementById("codigoSalaDisplay").textContent = codigo;
    isHost = host;
    salaDados = null;

    // Reset areas
    document.getElementById("msgSala").textContent = "Aguardando host iniciar a votação...";
    document.getElementById("votacaoHostArea").classList.add("hidden");
    document.getElementById("votacaoParticipanteArea").classList.add("hidden");
    document.getElementById("quizIniciadoArea").classList.add("hidden");

    if (host) {
      document.getElementById("msgSala").textContent = "Você é o host. Prepare a votação.";
      document.getElementById("votacaoHostArea").classList.remove("hidden");
      prepararListaMateriasVotacao();
    }
  }

  // Prepara lista de matérias para host votar
  function prepararListaMateriasVotacao() {
    const lista = document.getElementById("listaMateriasVotacao");
    lista.querySelectorAll("li").forEach(li => li.classList.remove("selected"));
  }

  // Seleção matérias para votação host
  document.getElementById("listaMateriasVotacao").addEventListener("click", (e) => {
    if (e.target.tagName === "LI") {
      e.target.classList.toggle("selected");
    }
  });

  // Iniciar votação
  document.getElementById("btnIniciarVotacao").addEventListener("click", async () => {
    const selecionadas = Array.from(document.querySelectorAll("#listaMateriasVotacao li.selected"))
      .map(li => li.dataset.materia);

    if (selecionadas.length === 0) {
      alert("Selecione pelo menos uma matéria para iniciar a votação.");
      return;
    }

    try {
      await atualizarSala(codigoSalaAtual, {
        status: "votacao",
        materias: selecionadas,
        votos: {}
      });
      document.getElementById("msgSala").textContent = "Votação iniciada! Participantes, votem na matéria.";
      document.getElementById("votacaoHostArea").classList.add("hidden");
      mostrarAreaVotacaoParticipante();
    } catch (err) {
      alert("Erro ao iniciar votação.");
      console.error(err);
    }
  });

  // Mostrar área de votação para participantes
  function mostrarAreaVotacaoParticipante() {
    document.getElementById("votacaoParticipanteArea").classList.remove("hidden");
    const listaVotos = document.getElementById("listaVotosParticipante");
    listaVotos.innerHTML = "";

    salaDados.materias.forEach(materia => {
      const li = document.createElement("li");
      li.textContent = materia;
      li.tabIndex = 0;
      li.setAttribute("role", "button");
      li.setAttribute("aria-pressed", "false");
      li.addEventListener("click", () => votarMateria(materia));
      li.addEventListener("keydown", e => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          votarMateria(materia);
        }
      });
      listaVotos.appendChild(li);
    });
  }

  // Votar matéria
  async function votarMateria(materia) {
    if (!codigoSalaAtual || !usuarioLogado) return;
    if (salaDados.votos && salaDados.votos[usuarioLogado]) {
      alert("Você já votou!");
      return;
    }
    salaDados.votos[usuarioLogado] = materia;
    try {
      await atualizarSala(codigoSalaAtual, { votos: salaDados.votos });
      alert(`Você votou em ${materia}. Aguarde os resultados.`);
    } catch (err) {
      alert("Erro ao registrar voto.");
      console.error(err);
    }
  }

  // Botão sair da sala
  document.getElementById("btnSairSala").addEventListener("click", () => {
    // Voltar para tela inicial
    codigoSalaAtual = null;
    isHost = false;
    salaDados = null;
    mostrarSecao("homeSection");
  });

  // --- ATUALIZAR SALA EM TEMPO REAL ---
  // Como o Realtime Database não tem WebSocket puro, vamos usar polling a cada 3 seg para atualizar a sala
  let pollInterval = null;

  function iniciarAtualizacaoSala(codigo) {
    if (pollInterval) clearInterval(pollInterval);

    pollInterval = setInterval(async () => {
      try {
        const res = await fetch(`${firebaseSalasURL}/${codigo}.json`);
        if (!res.ok) throw new Error("Erro ao atualizar sala");
        salaDados = await res.json();

        // Atualiza UI dependendo do status
        if (!salaDados) return;

        if (salaDados.status === "aguardando") {
          document.getElementById("msgSala").textContent = isHost
            ? "Você é o host. Prepare a votação."
            : "Aguardando host iniciar a votação...";
          document.getElementById("votacaoHostArea").classList.toggle("hidden", !isHost);
          document.getElementById("votacaoParticipanteArea").classList.add("hidden");
          document.getElementById("quizIniciadoArea").classList.add("hidden");

        } else if (salaDados.status === "votacao") {
          document.getElementById("msgSala").textContent = "Votação em andamento!";
          document.getElementById("votacaoHostArea").classList.add("hidden");

          if (!isHost) {
            document.getElementById("votacaoParticipanteArea").classList.remove("hidden");
            mostrarAreaVotacaoParticipante();
          }

          document.getElementById("quizIniciadoArea").classList.add("hidden");

          // Verificar se todos votaram (todos participantes menos o host)
          const participantesSemHost = salaDados.participantes.filter(p => p !== salaDados.host);
          const votosFeitos = Object.keys(salaDados.votos || {});
          if (votosFeitos.length >= participantesSemHost.length && participantesSemHost.length > 0) {
            // Contar votos para escolher matéria vencedora
            const contagem = {};
            votosFeitos.forEach(nome => {
              const voto = salaDados.votos[nome];
              if (voto) contagem[voto] = (contagem[voto] || 0) + 1;
            });

            // Encontrar matéria com mais votos
            let maxVotos = 0;
            let materiaVencedora = null;
            for (const mat in contagem) {
              if (contagem[mat] > maxVotos) {
                maxVotos = contagem[mat];
                materiaVencedora = mat;
              }
            }

            // Atualizar sala para quiz iniciado
            await atualizarSala(codigoSalaAtual, {
              status: "quiz",
              materiaEscolhida: materiaVencedora
            });
          }

        } else if (salaDados.status === "quiz") {
          document.getElementById("msgSala").textContent = "Quiz iniciado!";
          document.getElementById("votacaoHostArea").classList.add("hidden");
          document.getElementById("votacaoParticipanteArea").classList.add("hidden");
          document.getElementById("quizIniciadoArea").classList.remove("hidden");

          // Mostrar matéria escolhida
          document.getElementById("materiasEscolhidasDisplay").textContent = "Matéria escolhida: " + (salaDados.materiaEscolhida || "N/A");
        }

      } catch (err) {
        console.error("Erro atualização sala:", err);
      }
    }, 3000);
  }

  // Inicia mostrando o login
  mostrarSecao("loginSection");
</script>

</body>
</html>
