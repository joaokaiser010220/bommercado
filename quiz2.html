<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quiz Online - Pequenos Gênios</title>
<style>
  /* Reset básico */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; 
    font-family: 'Comic Neue', cursive, 'Comic Sans MS', cursive, sans-serif;
    background: #d0f0c0;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    color: #2e7d32;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  header {
    background: #4caf50;
    padding: 16px 20px;
    color: white;
    font-weight: 700;
    font-size: 1.7rem;
    text-align: center;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    font-family: 'Fredoka One', cursive, 'Comic Neue', cursive;
  }
  main {
    flex: 1;
    max-width: 480px;
    margin: 20px auto 40px;
    background: white;
    border-radius: 20px;
    padding: 25px 20px 30px;
    box-shadow: 0 5px 18px rgba(0,0,0,0.1);
  }
  h2 {
    text-align: center;
    font-weight: 700;
    margin-bottom: 25px;
    font-family: 'Fredoka One', cursive, 'Comic Neue', cursive;
    color: #2e7d32;
  }
  label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
  }
  input[type=text] {
    width: 100%;
    padding: 12px 15px;
    margin-bottom: 18px;
    border: 2.5px solid #4caf50;
    border-radius: 14px;
    font-size: 1.1rem;
    transition: border-color 0.3s ease;
    font-family: 'Comic Neue', cursive, 'Comic Sans MS', cursive, sans-serif;
  }
  input[type=text]:focus {
    border-color: #2e7d32;
    outline: none;
  }
  button {
    width: 100%;
    background: #4caf50;
    color: white;
    font-size: 1.3rem;
    font-weight: 700;
    padding: 14px 0;
    border: none;
    border-radius: 24px;
    cursor: pointer;
    box-shadow: 0 6px 12px rgba(46,125,50,0.5);
    transition: background-color 0.3s ease;
    font-family: 'Fredoka One', cursive, 'Comic Neue', cursive;
  }
  button:hover, button:focus {
    background: #2e7d32;
    outline: none;
  }
  .flex-row {
    display: flex;
    gap: 20px;
    margin-bottom: 25px;
  }
  .flex-row button {
    flex: 1;
  }
  .hidden {
    display: none;
  }
  .message-box {
    background: #ffecb3;
    border-radius: 14px;
    padding: 12px 15px;
    margin-bottom: 18px;
    font-weight: 700;
    color: #5d4037;
    text-align: center;
  }
  /* Lista de matérias para votação */
  .materias-lista {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
    margin-bottom: 25px;
  }
  .materia-item {
    background: #a5d6a7;
    padding: 12px 18px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 700;
    color: #1b5e20;
    user-select: none;
    flex: 1 0 40%;
    text-align: center;
    box-shadow: 0 3px 8px rgba(0,0,0,0.12);
    transition: background-color 0.3s ease;
  }
  .materia-item.selected {
    background: #4caf50;
    color: white;
  }
  /* Código sala fixo */
  #codigoSalaExibido {
    background: #4caf50;
    color: white;
    font-weight: 700;
    font-size: 1.3rem;
    padding: 10px 14px;
    border-radius: 14px;
    text-align: center;
    margin-bottom: 20px;
    user-select: all;
  }
  /* Status geral da sala */
  #statusSala, #statusSalaAguardando {
    font-weight: 700;
    text-align: center;
    font-size: 1.2rem;
    margin-bottom: 20px;
    color: #2e7d32;
  }

  /* Responsivo */
  @media(max-width:480px) {
    main {
      margin: 10px 12px 30px;
      padding: 20px 12px 25px;
    }
  }
</style>
<!-- Google Fonts para fontes infantis -->
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Comic+Neue:wght@700&display=swap" rel="stylesheet" />
</head>
<body>

<header>Quiz Online - Pequenos Gênios</header>

<main>

  <!-- Tela Inicial com 2 botões -->
  <section id="telaInicial">
    <div class="flex-row">
      <button id="btnCriarSala">Criar Quiz Online</button>
      <button id="btnEntrarSala">Entrar na Sala</button>
    </div>
  </section>

  <!-- Tela Criar Sala -->
  <section id="telaCriarSala" class="hidden">
    <h2>Criar Sala</h2>
    <label for="inputNomeHost">Seu nome (host):</label>
    <input id="inputNomeHost" type="text" placeholder="Digite seu nome" autocomplete="off" />
    <div id="msgCriarSala" class="message-box hidden"></div>
    <button id="btnGerarSala">Gerar código e criar sala</button>
    <button id="btnVoltarCriar" style="margin-top:12px; background:#ccc; color:#2e7d32;">Voltar</button>
  </section>

  <!-- Tela Entrar Sala -->
  <section id="telaEntrarSala" class="hidden">
    <h2>Entrar na Sala</h2>
    <label for="inputCodigoSala">Código da sala:</label>
    <input id="inputCodigoSala" type="text" maxlength="6" placeholder="Ex: G6VYEE" autocomplete="off" />
    <label for="inputNomeParticipante">Seu nome:</label>
    <input id="inputNomeParticipante" type="text" placeholder="Digite seu nome" autocomplete="off" />
    <div id="msgEntrarSala" class="message-box hidden"></div>
    <button id="btnEntrarConfirmar">Entrar</button>
    <button id="btnVoltarEntrar" style="margin-top:12px; background:#ccc; color:#2e7d32;">Voltar</button>
  </section>

  <!-- Tela de votação (host) -->
  <section id="telaVotacao" class="hidden">
    <h2>Iniciar Votação das Matérias</h2>
    <div id="codigoSalaExibido" title="Código da sala"></div>
    <div id="statusSala"></div>
    <div class="materias-lista" id="listaMaterias">
      <!-- Matérias aparecerão aqui para escolher -->
    </div>
    <button id="btnIniciarQuiz" disabled>Iniciar Quiz</button>
    <button id="btnCancelarVotacao" style="margin-top:12px; background:#ccc; color:#2e7d32;">Cancelar</button>
  </section>

  <!-- Tela aguardando quiz iniciar -->
  <section id="telaAguardando" class="hidden">
    <h2>Aguardando o host iniciar o quiz...</h2>
    <div id="codigoSalaExibidoParticipante" title="Código da sala"></div>
    <div id="statusSalaAguardando"></div>
    <div id="materiasVotacaoParticipante" class="materias-lista" style="margin-bottom:15px;"></div>
    <button id="btnSairFila">Sair da sala</button>
  </section>

</main>

<script>
  const FIREBASE_SALAS = "https://sapichoes1-default-rtdb.firebaseio.com/salas";

  const telaInicial = document.getElementById("telaInicial");
  const telaCriarSala = document.getElementById("telaCriarSala");
  const telaEntrarSala = document.getElementById("telaEntrarSala");
  const telaVotacao = document.getElementById("telaVotacao");
  const telaAguardando = document.getElementById("telaAguardando");

  const inputNomeHost = document.getElementById("inputNomeHost");
  const btnGerarSala = document.getElementById("btnGerarSala");
  const msgCriarSala = document.getElementById("msgCriarSala");
  const btnVoltarCriar = document.getElementById("btnVoltarCriar");

  const inputCodigoSala = document.getElementById("inputCodigoSala");
  const inputNomeParticipante = document.getElementById("inputNomeParticipante");
  const btnEntrarConfirmar = document.getElementById("btnEntrarConfirmar");
  const msgEntrarSala = document.getElementById("msgEntrarSala");
  const btnVoltarEntrar = document.getElementById("btnVoltarEntrar");

  const listaMaterias = document.getElementById("listaMaterias");
  const btnIniciarQuiz = document.getElementById("btnIniciarQuiz");
  const btnCancelarVotacao = document.getElementById("btnCancelarVotacao");
  const statusSala = document.getElementById("statusSala");

  const statusSalaAguardando = document.getElementById("statusSalaAguardando");
  const btnSairFila = document.getElementById("btnSairFila");
  const materiasVotacaoParticipante = document.getElementById("materiasVotacaoParticipante");
  const codigoSalaExibido = document.getElementById("codigoSalaExibido");
  const codigoSalaExibidoParticipante = document.getElementById("codigoSalaExibidoParticipante");

  const todasMaterias = ["Matemática", "Português", "História", "Geografia", "Ciências", "Inglês", "Artes"];

  let codigoSalaAtual = null;
  let nomeHostAtual = null;
  let nomeParticipanteAtual = null;
  let materiasSelecionadas = [];

  // Intervalo para atualizar status ao entrar
  let pollingInterval = null;

  function gerarCodigoSala() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    let codigo = "";
    for(let i=0; i<6; i++) {
      codigo += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return codigo;
  }

  // Mostrar uma tela e esconder as outras
  function mostrarTela(tela) {
    [telaInicial, telaCriarSala, telaEntrarSala, telaVotacao, telaAguardando].forEach(t => {
      t.classList.add("hidden");
    });
    tela.classList.remove("hidden");
  }

  // Criar sala no Firebase
  async function criarSala(nomeHost) {
    const codigo = gerarCodigoSala();
    const novaSala = {
      host: nomeHost,
      materias: todasMaterias,
      status: "aguardando",
      participantes: []
    };

    const url = `${FIREBASE_SALAS}/${codigo}.json`;
    const response = await fetch(url, {
      method: "PUT",
      body: JSON.stringify(novaSala),
      headers: {"Content-Type": "application/json"}
    });

    if (!response.ok) throw new Error("Erro ao criar sala");
    return codigo;
  }

  // Buscar sala no Firebase pelo código
  async function buscarSala(codigo) {
    const url = `${FIREBASE_SALAS}/${codigo}.json`;
    const response = await fetch(url);
    if (!response.ok) throw new Error("Erro ao acessar sala");
    const sala = await response.json();
    return sala;
  }

  // Atualizar status da sala
  async function atualizarStatusSala(codigo, novoStatus) {
    const url = `${FIREBASE_SALAS}/${codigo}/status.json`;
    const response = await fetch(url, {
      method: "PUT",
      body: JSON.stringify(novoStatus),
      headers: {"Content-Type": "application/json"}
    });
    if (!response.ok) throw new Error("Erro ao atualizar status");
  }

  // Atualizar matérias escolhidas da sala
  async function atualizarMateriasSala(codigo, materias) {
    const url = `${FIREBASE_SALAS}/${codigo}/materias.json`;
    const response = await fetch(url, {
      method: "PUT",
      body: JSON.stringify(materias),
      headers: {"Content-Type": "application/json"}
    });
    if (!response.ok) throw new Error("Erro ao atualizar matérias");
  }

  // Adicionar participante na sala
  async function adicionarParticipanteSala(codigo, nomeParticipante) {
    // Buscar sala e participantes
    const urlSala = `${FIREBASE_SALAS}/${codigo}.json`;
    const response = await fetch(urlSala);
    if (!response.ok) throw new Error("Erro ao buscar sala");
    const sala = await response.json();

    if (!sala.participantes) sala.participantes = [];

    if (!sala.participantes.includes(nomeParticipante)) {
      sala.participantes.push(nomeParticipante);

      const urlPart = `${FIREBASE_SALAS}/${codigo}/participantes.json`;
      const respPut = await fetch(urlPart, {
        method: "PUT",
        body: JSON.stringify(sala.participantes),
        headers: {"Content-Type": "application/json"}
      });
      if (!respPut.ok) throw new Error("Erro ao adicionar participante");
    }
  }

  // Remover participante da sala (na verdade aqui só recarrega, para sistema mais complexo precisaria implementar)
  function sairSala() {
    location.reload();
  }

  // Monta lista de matérias para votar
  function montarListaMaterias() {
    listaMaterias.innerHTML = "";
    materiasSelecionadas = [];
    todasMaterias.forEach(materia => {
      const btn = document.createElement("div");
      btn.className = "materia-item";
      btn.textContent = materia;
      btn.tabIndex = 0;
      btn.setAttribute("role", "button");
      btn.addEventListener("click", () => {
        if (btn.classList.contains("selected")) {
          btn.classList.remove("selected");
          materiasSelecionadas = materiasSelecionadas.filter(m => m !== materia);
        } else {
          btn.classList.add("selected");
          materiasSelecionadas.push(materia);
        }
        btnIniciarQuiz.disabled = materiasSelecionadas.length === 0;
      });
      btn.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          btn.click();
        }
      });
      listaMaterias.appendChild(btn);
    });
  }

  // Montar lista matérias para participantes na tela aguardando
  function montarListaMateriasParticipante(materias) {
    materiasVotacaoParticipante.innerHTML = "";
    materias.forEach(materia => {
      const div = document.createElement("div");
      div.className = "materia-item selected";
      div.textContent = materia;
      materiasVotacaoParticipante.appendChild(div);
    });
  }

  // Atualizar status e UI para o participante (polling)
  async function atualizarTelaParticipante() {
    try {
      if (!codigoSalaAtual) return;
      const sala = await buscarSala(codigoSalaAtual);
      if (!sala) {
        msgEntrarSala.textContent = "Sala não encontrada.";
        return;
      }

      // Mostrar código da sala no participante
      codigoSalaExibidoParticipante.textContent = codigoSalaAtual;

      if (sala.status === "aguardando") {
        statusSalaAguardando.textContent = "Aguardando o host iniciar o quiz...";
        materiasVotacaoParticipante.innerHTML = "";
      } else if (sala.status === "votacao") {
        statusSalaAguardando.textContent = "Votação iniciada! Escolha as matérias no host.";
        montarListaMateriasParticipante(sala.materias || []);
      } else if (sala.status === "quiz") {
        statusSalaAguardando.textContent = "Quiz iniciado! Aguarde as perguntas.";
        // Aqui poderia redirecionar para quiz real
      } else {
        statusSalaAguardando.textContent = "Status da sala desconhecido. Aguarde.";
      }
    } catch {
      statusSalaAguardando.textContent = "Erro ao atualizar a sala. Tente novamente.";
    }
  }

  // Atualizar status e UI para host (polling)
  async function atualizarTelaHost() {
    try {
      if (!codigoSalaAtual) return;
      const sala = await buscarSala(codigoSalaAtual);
      if (!sala) {
        statusSala.textContent = "Sala não encontrada.";
        return;
      }
      codigoSalaExibido.textContent = codigoSalaAtual;
      statusSala.textContent = `Você é o host: ${nomeHostAtual}. Selecione as matérias para votação.`;
      montarListaMaterias();

      // Desabilitar botão iniciar quiz se não tem matérias selecionadas
      btnIniciarQuiz.disabled = materiasSelecionadas.length === 0;
    } catch {
      statusSala.textContent = "Erro ao atualizar a sala.";
    }
  }

  // Polling para atualizar telas a cada 2 segundos
  function iniciarPolling() {
    if (pollingInterval) clearInterval(pollingInterval);
    pollingInterval = setInterval(async () => {
      if (telaVotacao.classList.contains("hidden") === false) {
        await atualizarTelaHost();
      } else if (telaAguardando.classList.contains("hidden") === false) {
        await atualizarTelaParticipante();
      }
    }, 2000);
  }

  // Eventos botões e navegação

  // Tela inicial -> criar sala
  document.getElementById("btnCriarSala").addEventListener("click", () => {
    mostrarTela(telaCriarSala);
  });

  // Tela inicial -> entrar sala
  document.getElementById("btnEntrarSala").addEventListener("click", () => {
    mostrarTela(telaEntrarSala);
  });

  // Voltar criar sala -> inicial
  btnVoltarCriar.addEventListener("click", () => {
    mostrarTela(telaInicial);
    msgCriarSala.classList.add("hidden");
  });

  // Voltar entrar sala -> inicial
  btnVoltarEntrar.addEventListener("click", () => {
    mostrarTela(telaInicial);
    msgEntrarSala.classList.add("hidden");
  });

  // Criar sala no Firebase
  btnGerarSala.addEventListener("click", async () => {
    const nomeHost = inputNomeHost.value.trim();
    msgCriarSala.classList.add("hidden");
    if (!nomeHost) {
      msgCriarSala.textContent = "Digite seu nome para criar a sala.";
      msgCriarSala.classList.remove("hidden");
      return;
    }

    btnGerarSala.disabled = true;
    btnGerarSala.textContent = "Criando sala...";

    try {
      const codigo = await criarSala(nomeHost);
      codigoSalaAtual = codigo;
      nomeHostAtual = nomeHost;
      mostrarTela(telaVotacao);
      msgCriarSala.classList.add("hidden");
      materiasSelecionadas = [];
      iniciarPolling();
    } catch (error) {
      msgCriarSala.textContent = "Erro ao criar sala. Tente novamente.";
      msgCriarSala.classList.remove("hidden");
    } finally {
      btnGerarSala.disabled = false;
      btnGerarSala.textContent = "Gerar código e criar sala";
    }
  });

  // Entrar na sala
  btnEntrarConfirmar.addEventListener("click", async () => {
    const codigo = inputCodigoSala.value.trim().toUpperCase();
    const nomeParticipante = inputNomeParticipante.value.trim();
    msgEntrarSala.classList.add("hidden");

    if (!codigo || codigo.length !== 6) {
      msgEntrarSala.textContent = "Digite um código de sala válido (6 caracteres).";
      msgEntrarSala.classList.remove("hidden");
      return;
    }
    if (!nomeParticipante) {
      msgEntrarSala.textContent = "Digite seu nome para entrar na sala.";
      msgEntrarSala.classList.remove("hidden");
      return;
    }

    btnEntrarConfirmar.disabled = true;
    btnEntrarConfirmar.textContent = "Entrando...";

    try {
      const sala = await buscarSala(codigo);
      if (!sala) {
        msgEntrarSala.textContent = "Sala não encontrada.";
        msgEntrarSala.classList.remove("hidden");
        return;
      }

      // Adicionar participante na sala
      await adicionarParticipanteSala(codigo, nomeParticipante);

      codigoSalaAtual = codigo;
      nomeParticipanteAtual = nomeParticipante;
      mostrarTela(telaAguardando);
      iniciarPolling();
    } catch (error) {
      msgEntrarSala.textContent = "Erro ao entrar na sala. Tente novamente.";
      msgEntrarSala.classList.remove("hidden");
    } finally {
      btnEntrarConfirmar.disabled = false;
      btnEntrarConfirmar.textContent = "Entrar";
    }
  });

  // Iniciar votação (host)
  btnIniciarQuiz.addEventListener("click", async () => {
    if (materiasSelecionadas.length === 0) return;

    btnIniciarQuiz.disabled = true;
    statusSala.textContent = "Iniciando votação no servidor...";

    try {
      await atualizarMateriasSala(codigoSalaAtual, materiasSelecionadas);
      await atualizarStatusSala(codigoSalaAtual, "votacao");
      statusSala.textContent = "Votação iniciada! Participantes estão votando...";
    } catch (error) {
      statusSala.textContent = "Erro ao iniciar votação.";
      btnIniciarQuiz.disabled = false;
    }
  });

  // Cancelar votação (host)
  btnCancelarVotacao.addEventListener("click", async () => {
    if (!confirm("Deseja cancelar a votação e voltar para a tela inicial?")) return;
    try {
      await atualizarStatusSala(codigoSalaAtual, "aguardando");
      mostrarTela(telaInicial);
      clearInterval(pollingInterval);
    } catch {
      alert("Erro ao cancelar votação.");
    }
  });

  // Sair da sala (participante)
  btnSairFila.addEventListener("click", () => {
    if (confirm("Deseja sair da sala?")) {
      location.reload();
    }
  });

</script>

</body>
</html>
